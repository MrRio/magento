/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Open Software License (OSL 3.0)
 * that is bundled with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/osl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * @copyright  Copyright (c) 2004-2007 Irubin Consulting Inc. DBA Varien (http://www.varien.com)
 * @license    http://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0)
 */
/*
 * Magento-Admin
 * Copyright(c) Varien inc. 2006-2007, Andrey Korolyov.
 */


Ext.UpdateManager.defaults.loadScripts=false;Ext.UpdateManager.defaults.disableCaching=true;Mage=new Object();Mage.url=BASE_URL;Mage.skin=SKIN_URL;Mage.Collection=new Ext.util.MixedCollection;

Mage.Form=function(form){var that=this;this.elements=new Ext.util.MixedCollection(false);this.form=Ext.getDom(form);this.id=form.id;this.action=form.action;this.method=form.method;this.timeout=10000;this.transId=null;this.disabled=false;this.scipFile=true;this.enctype=form.getAttribute("enctype");if(this.enctype&&this.enctype.toLowerCase()=="multipart/form-data"){this.isUpload=true;}
this._parseElements=function(form){var i=0;for(i=0;i<form.elements.length;i++){this.elements.add(form.elements[i].name,form.elements[i]);}}
this._parseElements(this.form);this.appendForm=function(form,force){if(form.action!=this.action&&!force){return false;}
this._parseElements(form);}
this.sendForm=function(callBack,reset){if(!this.action){Ext.MessageBox.alert('Form','From action do not set');return false;}
var i=0;var formData='';var elm;for(i=0;i<this.elements.getCount();i++){elm=this.elements.itemAt(i);oElement=elm;oDisabled=elm.disabled;oName=elm.name;oValue=elm.value;if(!oDisabled&&oName)
{switch(oElement.type)
{case'select-one':case'select-multiple':for(var j=0;j<oElement.options.length;j++){if(oElement.options[j].selected){if(window.ActiveXObject){formData+=encodeURIComponent(oName)+'='+encodeURIComponent(oElement.options[j].attributes['value'].specified?oElement.options[j].value:oElement.options[j].text)+'&';}
else{formData+=encodeURIComponent(oName)+'='+encodeURIComponent(oElement.options[j].hasAttribute('value')?oElement.options[j].value:oElement.options[j].text)+'&';}}}
break;case'radio':case'checkbox':if(oElement.checked){formData+=encodeURIComponent(oName)+'='+encodeURIComponent(oValue)+'&';}
break;case'file':case undefined:case'reset':case'button':break;case'submit':if(hasSubmit==false){formData+=encodeURIComponent(oName)+'='+encodeURIComponent(oValue)+'&';hasSubmit=true;}
break;default:formData+=encodeURIComponent(oName)+'='+encodeURIComponent(oValue)+'&';break;}}}
formData=formData.substr(0,formData.length-1);var cb={success:this.successDelegate,failure:this.failureDelegate,timeout:this.timeout,argument:{"url":this.action,"method":this.method,"form":this.form,"reset":reset,"callBack":callBack}}
this.transId=Ext.lib.Ajax.request(this.method,this.action,cb,formData);}
this.processSuccess=function(response){if(typeof response.argument.callBack=='function'){response.argument.callBack(response,{success:true});}}
this.processFailure=function(response){if(typeof response.argument.callBack=='function'){response.argument.callBack(response,{success:false});}}
this.disable=function(){var i=0;for(i=0;i<this.elements.getCount();i++){var elm=this.elements.itemAt(i);elm.disabled=true;this.disabled=true;}}
this.enable=function(){var i;for(i=0;i<this.elements.getCount();i++){var elm=this.elements.itemAt(i);elm.disabled=false;this.disabled=false;}}
this.successDelegate=this.processSuccess.createDelegate(this);this.failureDelegate=this.processFailure.createDelegate(this);};

var Cookies={};Cookies.set=function(name,value){var argv=arguments;var argc=arguments.length;var expires=(argc>2)?argv[2]:null;var path=(argc>3)?argv[3]:'/';var domain=(argc>4)?argv[4]:null;var secure=(argc>5)?argv[5]:false;document.cookie=name+"="+escape(value)+
((expires==null)?"":("; expires="+expires.toGMTString()))+
((path==null)?"":("; path="+path))+
((domain==null)?"":("; domain="+domain))+
((secure==true)?"; secure":"");};Cookies.get=function(name){var arg=name+"=";var alen=arg.length;var clen=document.cookie.length;var i=0;var j=0;while(i<clen){j=i+alen;if(document.cookie.substring(i,j)==arg)
return Cookies.getCookieVal(j);i=document.cookie.indexOf(" ",i)+1;if(i==0)
break;}
return null;};Cookies.clear=function(name){if(Cookies.get(name)){document.cookie=name+"="+"; expires=Thu, 01-Jan-70 00:00:01 GMT";}};Cookies.getCookieVal=function(offset){var endstr=document.cookie.indexOf(";",offset);if(endstr==-1){endstr=document.cookie.length;}
return unescape(document.cookie.substring(offset,endstr));};Mage.Core=function(){var _layout;var _leftToolbar;var _rightToolbar;var _lToolbarItems=new Ext.util.MixedCollection();var _rToolbarItems=new Ext.util.MixedCollection();return{layout:null,init:function(){Ext.get('loading').remove();_layout=new Ext.BorderLayout(document.body,{"hideOnLayout":true,"north":{"split":false,"titlebar":false,"collapsible":false},"center":{resizeTabs:true,alwaysShowTabs:false,hideTabs:true,tabPosition:'top',titlebar:false,autoScroll:true,closeOnTab:true},"south":{"split":false,"initialSize":22,"titlebar":false,"collapsible":false,"animate":false},"east":{collapsedTitle:'<strong>TaskBar</strong>',"split":true,"initialSize":150,"autoScroll":true,"collapsible":true,"titlebar":true,"animate":false}});_layout.getRegion('east').getEl().addClass('my-tasks-region');_layout.beginUpdate();_layout.add('north',new Ext.ContentPanel('north',{"title":"Top Panel","autoCreate":true}));_layout.add('center',new Ext.ContentPanel('center',{title:"DashBoard",fitToFrame:true,autoCreate:true}));_layout.add('south',new Ext.ContentPanel('south',{"autoCreate":true}));_layout.add('east',new Ext.ContentPanel('east',{"title":"My Tasks","autoCreate":true}));this._initToolbar();_layout.endUpdate();},_initToolbar:function(){_leftToolbar=new Ext.Toolbar(Ext.DomHelper.insertFirst(_layout.getRegion('north').getEl().dom,{tag:'div'},true));_leftToolbar.add(_lToolbarItems.items);_leftToolbar.getEl().addClass('left-menu-toolbar')
_rightToolbar=new Ext.Toolbar(Ext.DomHelper.insertFirst(_layout.getRegion('north').getEl().dom,{tag:'div'},true));_rightToolbar.add(_rToolbarItems.items);_rightToolbar.getEl().addClass('right-menu-toolbar')},getLayoutRegion:function(region){return _layout.getRegion(region);},getLayout:function(){return _layout;},getRighToolbar:function(){return _rightToolbar;},addLeftToolbarItem:function(item){_lToolbarItems.add(item);},addRightToolbarItem:function(item){_rToolbarItems.add(item);},updateRegion:function(region,url){},applyDbUpdates:function(){var success=function(o){Ext.MessageBox.alert('Apply DB Updates',o.responseText);}
var failure=function(o){Ext.MessageBox.alert('Apply DB Updates',o.statusText);}
var cb={success:success,failure:failure,argument:{}};var con=new Ext.lib.Ajax.request('GET',Mage.url+'/index/applyDbUpdates',cb);}}}();Ext.EventManager.onDocumentReady(Mage.Core.init,Mage.Core,true);Mage.Search=function(){return{init:function(){var ds=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:Mage.url+'mage_core/search/do/'}),reader:new Ext.data.JsonReader({root:'items',totalProperty:'totalCount',id:'id'},[{name:'type',mapping:'type'},{name:'name',mapping:'name'},{name:'description',mapping:'description'}])});var resultTpl=new Ext.Template('<div class="search-item">','<h3><span>{type}</span>{name}</h3>','{description}','</div>');var comboSearch=new Ext.form.ComboBox({store:ds,displayField:'title',typeAhead:false,loadingText:'Searching...',width:250,pageSize:10,hideTrigger:true,tpl:resultTpl,onSelect:function(record){var id=record.id.split('/');switch(id[0]){case'product':Mage.Catalog_Product.viewGrid({load:true,catId:id[1],catTitle:''});Mage.Catalog_Product.doCreateItem(id[2],'yes');break;case'customer':Mage.Customer.loadMainPanel();Mage.Customer.customerCardId=id[2];Mage.Customer.showEditPanel();break;case'order':Mage.Sales.loadMainPanel();Mage.Sales.loadOrder({id:id[2],title:record.json.form_panel_title})
break;}}});Mage.Core.getRighToolbar().addField(comboSearch);}}}();Ext.EventManager.onDocumentReady(Mage.Search.init,Mage.Search,true);

Mage.Menu_Core=function(){var menu=null;return{add:function(config){if(menu){menu.add(config);}},init:function(){menu=new Ext.menu.Menu({id:'mainSystemMenu',items:[]});Mage.Core.addLeftToolbarItem({cls:'x-btn-text-icon bmenu',text:'System',menu:menu});},initRight:function(){function chooseTheme(item,e){var themeStyleEl=Ext.get('theme_stylesheet');Cookies.set('admtheme',item.value);themeStyleEl.dom.href=themeStyleEl.dom.href.replace(/(ytheme-).*(\.css)$/,'$1'+item.value+'$2');}
Mage.Core.getRighToolbar().add({cls:'x-btn-text-icon .btn-theme',text:'Theme',menu:new Ext.menu.Menu({id:'website',items:['<div class="choose-theme">Choose theme</div>',new Ext.menu.CheckItem({text:'Magento',checked:(Cookies.get('admtheme')=='magento')||false,group:'theme',value:'magento',handler:chooseTheme}),new Ext.menu.CheckItem({text:'Aero Glass',checked:(Cookies.get('admtheme')=='aero')||false,group:'theme',value:'aero',handler:chooseTheme}),new Ext.menu.CheckItem({text:'Vista Black',checked:(Cookies.get('admtheme')=='vista')||false,group:'theme',value:'vista',handler:chooseTheme}),new Ext.menu.CheckItem({text:'Gray Theme',group:'theme',checked:(Cookies.get('admtheme')=='gray')||false,value:'gray',handler:chooseTheme}),new Ext.menu.CheckItem({text:'Default Theme',group:'theme',checked:(Cookies.get('admtheme')=='default')||false,value:'default',handler:chooseTheme})]})});Mage.Core.getRighToolbar().add({cls:'x-btn-text-icon btn-logout',text:'Logout',handler:function(){window.location=Mage.url+'index/logout/'}});}}}();Ext.EventManager.onDocumentReady(Mage.Menu_Core.initRight,Mage.Menu_Core,true);Mage.Menu_Core.init();

Mage.Core_Blocks=function(){var blockDialog=null;return{init:function(){},showDialog:function(){Ext.QuickTips.init();if(!blockDialog){blockDialog=new Ext.LayoutDialog(Ext.id(),{autoCreate:true,width:700,height:500,minWidth:600,minHeight:400,syncHeightBeforeShow:true,shadow:true,fixedcenter:true,center:{autoScroll:false},west:{split:true,initialSize:200,minSize:150}});blockDialog.setTitle('Blocks & Layouts');blockDialog.setDefaultButton(blockDialog.addButton('Cancel',blockDialog.hide,blockDialog));var layout=blockDialog.getLayout();var blocks=layout.getEl().createChild({tag:'div',id:'blocks'});var tb=new Ext.Toolbar(blocks.createChild({tag:'div'}));tb.addButton({text:'New Block'});var viewEl=blocks.createChild({tag:'div',id:'folders'});var treePanel=layout.add('west',new Ext.ContentPanel(blocks,{title:'Blocks',fitToFrame:true,autoScroll:true,autoCreate:true,toolbar:tb,resizeEl:viewEl}));var tree=new Ext.tree.TreePanel(viewEl,{animate:true,loader:new Ext.tree.TreeLoader({dataUrl:Mage.url+'mage_core/block/blockChildren/'}),enableDD:true,containerScroll:true,dropConfig:{appendOnly:true}});var root=new Ext.tree.AsyncTreeNode({text:'Config',draggable:false,id:'config'});tree.setRootNode(root);tree.render();var centerPanel=layout.add('center',new Ext.ContentPanel(Ext.id(),{autoCreate:true,fitToFrame:true}));}
blockDialog.show();}}}();Mage.Core_Blocks.init();

Mage.Core_Config=function(){var configDialog=null;return{init:function(){Mage.Menu_Core.add({text:'Configuration Browser',handler:Mage.Core_Config.showDialog.createDelegate(Mage.Core_Config)});},showDialog:function(){Ext.QuickTips.init();if(!configDialog){configDialog=new Ext.LayoutDialog(Ext.id(),{autoCreate:true,width:700,height:500,minWidth:600,minHeight:400,syncHeightBeforeShow:true,shadow:true,fixedcenter:true,center:{autoScroll:false},west:{split:true,initialSize:200}});configDialog.setTitle('Configuration Browser');configDialog.setDefaultButton(configDialog.addButton('Cancel',configDialog.hide,configDialog));var layout=configDialog.getLayout();var config=layout.getEl().createChild({tag:'div',id:'config'});var tb=new Ext.Toolbar(config.createChild({tag:'div'}));tb.addButton({text:'New Node',cls:'x-btn-text-icon btn-add'});tb.addButton({text:'Remove Node',cls:'x-btn-text-icon btn-delete'});var viewEl=config.createChild({tag:'div',id:'folders'});var treePanel=layout.add('west',new Ext.ContentPanel(config,{title:'Config',fitToFrame:true,autoScroll:true,autoCreate:true,toolbar:tb,resizeEl:viewEl}));var tree=new Ext.tree.TreePanel(viewEl,{animate:true,loader:new Ext.tree.TreeLoader({dataUrl:Mage.url+'mage_core/config/configChildren/'}),enableDD:true,containerScroll:true,dropConfig:{appendOnly:true}});var root=new Ext.tree.AsyncTreeNode({text:'Config',draggable:false,id:'config'});tree.setRootNode(root);tree.render();var centerPanel=layout.add('center',new Ext.ContentPanel(Ext.id(),{autoCreate:true,fitToFrame:true}));}
configDialog.show();}}}();Mage.Core_Config.init();

Mage.Core_Media=function(){var mediaDialog=null;return{init:function(){Mage.Menu_Core.add('-');Mage.Menu_Core.add({text:'Media',handler:Mage.Core_Media.showDialog.createDelegate(Mage.Core_Media)});},showDialog:function(){Ext.QuickTips.init();if(!mediaDialog){mediaDialog=new Ext.LayoutDialog(Ext.id(),{title:'Media Browser',autoCreate:true,width:700,height:500,minWidth:600,minHeight:400,syncHeightBeforeShow:true,shadow:true,fixedcenter:true,west:{split:true,initialSize:300,collapsible:true},center:{autoScroll:false,hideTabs:true}});mediaDialog.setDefaultButton(mediaDialog.addButton('Close',mediaDialog.hide,mediaDialog));var centerLayout=new Ext.BorderLayout(mediaDialog.getLayout().getEl().createChild({tag:'div'}),{center:{title:'Folder name here',titlebar:true,autoScroll:true,hideTabs:true},south:{hideWhenEmpty:false,split:true,initialSize:300,minSize:50,titlebar:true,autoScroll:true,collapsible:true,hideTabs:true}});var centerPanel=mediaDialog.getLayout().add('center',new Ext.NestedLayoutPanel(centerLayout,{autoCreate:true,fitToFrame:true}));this.initTree();}
mediaDialog.show();},initTree:function(){var layout=mediaDialog.getLayout();var media=layout.getEl().createChild({tag:'div',id:'media'});var tb=new Ext.Toolbar(media.createChild({tag:'div'}));var viewEl=media.createChild({tag:'div',id:'folders'});var treePanel=layout.add('west',new Ext.ContentPanel(media,{title:'Media',fitToFrame:true,autoScroll:true,autoCreate:true,toolbar:tb,resizeEl:viewEl}));var tree=new Ext.tree.TreePanel(viewEl,{animate:true,loader:new Ext.tree.TreeLoader({dataUrl:Mage.url+'mage_core/media/foldersTree/'}),enableDD:true,containerScroll:true,dropConfig:{appendOnly:true}});var root=new Ext.tree.AsyncTreeNode({text:'Root',draggable:false,id:'/'});tb.addButton({id:'add',text:'New Folder',cls:'x-btn-text-icon btn-add',disabled:true});tb.addButton({id:'remove',text:'Remove Folder',cls:'x-btn-text-icon btn-delete',disabled:true});tb.addButton({id:'reload',text:'Reload',handler:function(){root.reload()},cls:'x-btn-text-icon btn-arrow-refresh',tooltip:'Reload the tree'});btns=tb.items.map;var sm=tree.getSelectionModel();sm.on('selectionchange',function(){var n=sm.getSelectedNode();if(!n){btns.add.disable();btns.remove.disable();return;}
var a=n.attributes;btns.add.setDisabled(false);btns.remove.setDisabled(false);});tree.setRootNode(root);tree.render();},initGrid:function(path){var dataRecord=Ext.data.Record.create([{name:'id',mapping:'product_id'},{name:'name',mapping:'name'},{name:'price',mapping:'price'},{name:'description',mapping:'description'}]);var dataReader=new Ext.data.JsonReader({root:'items',totalProperty:'totalRecords',id:'product_id'},dataRecord);var dataStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:Mage.url+'mage_catalog/product/gridData/category/'+catId+'/'}),reader:dataReader,remoteSort:true});dataStore.on('load',function(){if(!this.filterSettings){this.loadFilterSettings();}}.createDelegate(this));dataStore.setDefaultSort('product_id','desc');var colModel=new Ext.grid.ColumnModel([{header:"ID#",sortable:true,locked:false,dataIndex:'id'},{header:"Name",sortable:true,dataIndex:'name'},{header:"Price",sortable:true,renderer:Ext.util.Format.usMoney,dataIndex:'price'},{header:"Description",sortable:false,dataIndex:'description'}]);this.productsGrid=new Ext.grid.Grid(this.productLayout.getEl().createChild({tag:'div'}),{ds:dataStore,cm:colModel,autoSizeColumns:true,loadMask:true,monitorWindowResize:true,autoHeight:true,selModel:new Ext.grid.RowSelectionModel({singleSelect:true}),enableColLock:false});this.productsGrid.mageCategoryId=catId;this.productsGrid.on('rowclick',this.createItem.createDelegate(this));this.productsGrid.render();var gridHead=this.productsGrid.getView().getHeaderPanel(true);var gridFoot=this.productsGrid.getView().getFooterPanel(true);var paging=new Ext.PagingToolbar(gridHead,dataStore,{pageSize:this.productsGridPageSize,displayInfo:true,displayMsg:'Displaying products {0} - {1} of {2}',emptyMsg:'No products to display'});var btnAdd=new Ext.Toolbar.Button({text:'Filter',handler:this.addFilter.createDelegate(this),cls:'x-btn-text-icon btn-add',disabled:true});paging.insertButton(0,btnAdd);this.filterButtons.add('add',btnAdd);var btnApply=new Ext.Toolbar.Button({text:'Apply',handler:this.applyFilters.createDelegate(this),cls:'x-btn-text-icon btn-accept',disabled:true});paging.insertButton(1,btnApply);this.filterButtons.add('apply',btnApply);var bntReset=new Ext.Toolbar.Button({text:'Reset',handler:this.deleteFilters.createDelegate(this),cls:'x-btn-text-icon btn-delete',disabled:true});paging.insertButton(2,bntReset);this.filterButtons.add('clear',bntReset);paging.insertButton(3,{text:'Product',cls:'x-btn-text-icon btn-package-add',handler:this.createItem.createDelegate(this)});paging.insertButton(4,new Ext.Toolbar.Separator());},viewGrid:function(config){if(!config.catId){return false;}
this.init();if(!this.productLayout){this.initLayouts();}
if(config.catTitle){this.parentProductLayut.setTitle(config.catTitle);}
if(!this.gridPanel){this.initGrid(config.catId);this.productLayout.beginUpdate();this.gridPanel=this.productLayout.add('center',new Ext.GridPanel(this.productsGrid,{title:config.catTitle}));this.productLayout.endUpdate();if(config.load){this.productsGrid.getDataSource().load({params:{start:0,limit:this.productsGridPageSize}});}}else{this.gridPanel.getGrid();this.productsGrid.getDataSource().proxy.getConnection().url=Mage.url+'mage_catalog/product/gridData/category/'+config.catId+'/';if(config.load&&this.productsGrid.mageCategoryId!=config.catId){this.productsGrid.getDataSource().load({params:{start:0,limit:this.productsGridPageSize}});}
this.productsGrid.mageCategoryId=config.catId;}}}}();Mage.Core_Media.init();

Mage.Auth=function(depend){var loaded=false;var Layout=null;var UserTree=null;var GroupTree=null;var ActionTree=null;return{_layouts:new Ext.util.MixedCollection(true),init:function(){var Core_Layout=Mage.Core.getLayout();if(!Layout){Layout=new Ext.BorderLayout(Ext.DomHelper.append(Core_Layout.getEl(),{tag:'div'},true),{west:{split:true,autoScroll:true,collapsible:false,titlebar:true,minSize:200,maxSize:600,initialSize:200},center:{autoScroll:false,titlebar:true,hideTabs:false,minSize:200},east:{split:true,autoScroll:false,collapsible:false,titlebar:true,hideTabs:false,minSize:200,maxSize:600,initialSize:200},south:{split:true,autoScroll:false,collapsible:false,titlebar:true,hideTabs:false,minSize:200,maxSize:600,initialSize:200}});this._layouts.add('main',Layout);Layout.beginUpdate();Layout.add('west',new Ext.ContentPanel(Ext.id(),{title:'Users',autoCreate:true}));Layout.add('center',new Ext.ContentPanel(Ext.id(),{title:'Groups & Roles',autoCreate:true}));Layout.add('east',new Ext.ContentPanel(Ext.id(),{title:'Resources & Actions',autoCreate:true}));Layout.add('south',new Ext.ContentPanel(Ext.id(),{title:'Properties',autoCreate:true}));Layout.endUpdate();Core_Layout.beginUpdate();Core_Layout.add('center',new Ext.NestedLayoutPanel(Layout,{title:"User & Permission",closable:false}));Core_Layout.endUpdate();loaded=true;}else{Mage.Core.getLayout().getRegion('center').showPanel(Layout);}},getLayout:function(name){return this._layouts.get(name);},createUserTree:function(region){if(UserTree){return true;}
var treePanel=new Ext.tree.TreePanel(Ext.DomHelper.append(Layout.getRegion(region).getActivePanel().getEl().dom,{tag:'div'},true),{animate:true,loader:new Ext.tree.TreeLoader({dataUrl:Mage.url+'mage_auth/tree/user/'}),enableDD:true,containerScroll:true});UserTree=treePanel;var root=new Ext.tree.AsyncTreeNode({text:'All Users',draggable:false,id:'U0'});treePanel.setRootNode(root);treePanel.render();root.expand();},createGroupTree:function(region){if(GroupTree){return true;}
var treePanel=new Ext.tree.TreePanel(Ext.DomHelper.append(Layout.getRegion(region).getActivePanel().getEl().dom,{tag:'div'},true),{animate:true,loader:new Ext.tree.TreeLoader({dataUrl:Mage.url+'mage_auth/tree/role/'}),enableDD:true,containerScroll:true});GroupTree=treePanel;var root=new Ext.tree.AsyncTreeNode({text:'All Groups',draggable:false,id:'G0'});treePanel.setRootNode(root);treePanel.render();root.expand();},createActionTree:function(region){if(ActionTree){return true;}
var treePanel=new Ext.tree.TreePanel(Ext.DomHelper.append(Layout.getRegion(region).getActivePanel().getEl().dom,{tag:'div'},true),{animate:true,loader:new Ext.tree.TreeLoader({dataUrl:Mage.url+'mage_auth/tree/resource/'}),enableDD:true,containerScroll:true});ActionTree=treePanel
var root=new Ext.tree.AsyncTreeNode({text:'All Actions',draggable:false,id:'_'});treePanel.setRootNode(root);treePanel.render();root.expand();},loadMainPanel:function(){this.init();this.createUserTree('west');this.createGroupTree('center');this.createActionTree('east');}}}();

Mage.Menu_Auth=function(){return{init:function(){Mage.Menu_Core.add('-');Mage.Menu_Core.add({text:'Users & Permissions',handler:Mage.Auth.loadMainPanel.createDelegate(Mage.Auth)});}}}();Mage.Menu_Auth.init();

Mage.Customer=function(depend){var loaded=false;var Layout=null;var gridLayout=null;return{_layouts:new Ext.util.MixedCollection(true),baseLayout:null,customerLayout:null,editLayout:null,addressLayout:null,addressView:null,gridPanel:null,grid:null,addressLoading:null,addressPanel:null,addressViewUrl:Mage.url+'mage_customer/address/gridData/',addressViewForm:Mage.url+'mage_customer/address/form/',deleteAddressUrl:Mage.url+'mage_customer/address/delete/',customerCardUrl:Mage.url+'mage_customer/customer/card/',customerGridDataUrl:Mage.url+'mage_customer/customer/gridData/',deleteUrl:Mage.url+'mage_customer/customer/delete/',formPanels:new Ext.util.MixedCollection(),forms2Panel:new Ext.util.MixedCollection(),forms:new Ext.util.MixedCollection(),customerCardId:null,lastSelectedCustomer:null,tabCollections:new Ext.util.MixedCollection(),formsEdit:[],init:function(){var Core_Layout=Mage.Core.getLayout();if(!this.baseLayout){this.baseLayout=new Ext.BorderLayout(Ext.DomHelper.append(Core_Layout.getEl(),{tag:'div'},true),{center:{titlebar:false,autoScroll:true,resizeTabs:true,hideTabs:true,tabPosition:'top'}});this.customerLayout=new Ext.BorderLayout(Ext.DomHelper.append(Core_Layout.getEl(),{tag:'div'},true),{north:{hideWhenEmpty:true,titlebar:false,split:true,initialSize:21,minSize:21,maxSize:200,autoScroll:true,collapsible:false},center:{autoScroll:false,titlebar:false,hideTabs:true,preservPanels:true,},south:{preservePanels:true,hideWhenEmpty:true,split:true,initialSize:300,minSize:50,titlebar:true,autoScroll:true,collapsible:true,hideTabs:true}});this.baseLayout.beginUpdate();this.baseLayout.add('center',new Ext.NestedLayoutPanel(this.customerLayout));this.baseLayout.endUpdate();Core_Layout.add('center',new Ext.NestedLayoutPanel(this.baseLayout,{title:'Mange Customers'}));}else{Mage.Core.getLayout().getRegion('center').showPanel(this.baseLayout);}},viewGrid:function(){this.init();if(!this.gridPanel){var grid=this.initGrid();this.customerLayout.beginUpdate();this.gridPanel=this.customerLayout.add('center',new Ext.GridPanel(grid));this.customerLayout.endUpdate();this.grid.getDataSource().load({params:{start:0,limit:25}});}},getLayout:function(name){return this._layouts.get(name);},loadMainPanel:function(){this.viewGrid();},initGrid:function(parentLayout){var dataRecord=Ext.data.Record.create([{name:'customer_id',mapping:'customer_id'},{name:'email',mapping:'email'},{name:'firstname',mapping:'firstname'},{name:'lastname',mapping:'lastname'}]);var dataReader=new Ext.data.JsonReader({root:'items',totalProperty:'totalRecords',id:'customer_id'},dataRecord);var dataStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.customerGridDataUrl}),reader:dataReader,remoteSort:true});dataStore.setDefaultSort('customer_id','desc');var colModel=new Ext.grid.ColumnModel([{header:"ID#",sortable:true,locked:false,dataIndex:'customer_id'},{header:"Email",sortable:true,dataIndex:'email'},{header:"Firstname",sortable:true,dataIndex:'firstname'},{header:"Lastname",sortable:true,dataIndex:'lastname'}]);var rowSelector=new Ext.grid.RowSelectionModel({singleSelect:true});var grid=new Ext.grid.Grid(this.customerLayout.getEl().createChild({tag:'div'}),{ds:dataStore,cm:colModel,autoSizeColumns:true,monitorWindowResize:true,autoHeight:true,loadMask:true,selModel:rowSelector,enableColLock:false});grid.getSelectionModel().on('rowselect',this.createItem.createDelegate(this));this.grid=grid;this.grid.render();var gridHead=this.grid.getView().getHeaderPanel(true);var gridFoot=this.grid.getView().getFooterPanel(true);var paging=new Ext.PagingToolbar(gridHead,this.grid.getDataSource(),{pageSize:25,displayInfo:true,displayMsg:'Displaying customers {0} - {1} of {2}',emptyMsg:'No customers to display'});paging.add('-',{text:'Create New',cls:'x-btn-text-icon btn-add-user',handler:this.createItem.createDelegate(this,[this.customerLayout.getRegion('south')])});return grid;},createItem:function(sm,rowIndex,record){if(record){if(this.customerCardId==record.id){return false;}else{this.customerCardId=record.id;}}else{this.customerCardId=0;}
this.showEditPanel();},showEditPanel:function(){if(!this.editPanel){this.editLayout=new Ext.BorderLayout(this.customerLayout.getEl().createChild({tag:'div'}),{hideOnLayout:true,north:{split:false,initialSize:28,minSize:28,maxSize:28,autoScroll:false,titlebar:false,collapsible:false},center:{preservePanels:true,autoScroll:true,titlebar:false,resizeTabs:true,tabPosition:'top'}});if(!this.customerCardId){var deleteDisabled=true;var title='New Customer';}else{var deleteDisabled=false;var title='Edit Customer #'+this.customerCardId;}
toolbar=new Ext.Toolbar(Ext.DomHelper.insertFirst(this.editLayout.getRegion('north').getEl().dom,{tag:'div'},true));toolbar.add({text:'Save',cls:'x-btn-text-icon btn-accept',handler:this.saveItem.createDelegate(this)},{text:'Delete',cls:'x-btn-text-icon btn-bin-closed',handler:this.onDelete.createDelegate(this),disabled:deleteDisabled},{text:'Reset',cls:'x-btn-text-icon btn-arrow-undo',handler:this.onReset.createDelegate(this)},{text:'Cancel',cls:'x-btn-text-icon btn-cancel',handler:this.onCancelEdit.createDelegate(this)},'-');this.formLoading=toolbar.addButton({tooltip:'Form is updating',cls:"x-btn-icon x-grid-loading",disabled:false});toolbar.addSeparator();this.editLayout.add('north',new Ext.ContentPanel(this.editLayout.getEl().createChild({tag:'div'}),{toolbar:toolbar}));this.editPanel=this.customerLayout.add('south',new Ext.NestedLayoutPanel(this.editLayout,{closable:true,title:title}));}else{if(!this.customerCardId){var title='New Customer';}else{var title='Edit Customer #'+this.customerCardId;}
this.editPanel.setTitle(title);this.customerLayout.add('south',this.editPanel);}
var conn=new Ext.data.Connection();conn.on('requestcomplete',this.loadTabs.createDelegate(this));conn.on('requestexception',function(){Ext.MessageBox.alert('Error','Critical Error!!!');})
conn.request({method:'GET',url:this.customerCardUrl+'id/'+this.customerCardId+'/'});},loadTabs:function(conn,response,options){var dataCard=null;dataCard=Ext.decode(response.responseText);var panel=null;for(var i=0;i<dataCard.tabs.length;i++){var panel=this.createTabPanel(dataCard.tabs[i]);if(panel){this.editLayout.add('center',panel);if(dataCard.tabs[i].type=='form'){this.formPanels.add(panel.getId(),panel);}}}
this.editLayout.getRegion('center').showPanel(this.formPanel);},createTabPanel:function(tabInfo){var panel=null;switch(tabInfo.type){case'address':panel=this.createAddressTab(tabInfo);break;case'form':panel=this.careateFormTab(tabInfo);break;default:}
return panel;},saveItem:function(){var i;for(i=0;i<this.formsEdit.length;i++){if(this.forms.get(this.formsEdit[i])){var form=this.forms.get(this.formsEdit[i]);form.sendForm(this.saveItemCallBack.createDelegate(this,[form.id],0));form.disable();this.disableToolbar();var panel=this.forms2Panel.get(form.id);}}},saveItemCallBack:function(formId,response,type){if(type.success){var panel=this.forms2Panel.get(formId);panel.setTitle(panel.getTitle().substr(0,panel.getTitle().length-1));this.formsEdit.splice(this.formsEdit.indexOf(formId),1);}else{Ext.dump(response.responseText);}
this.enableToolbar();this.forms.get(formId).enable();},careateFormTab:function(tabInfo){if(!this.formPanel){this.formPanel=new Ext.ContentPanel('customerCard_'+tabInfo.name,{title:tabInfo.title,autoCreate:true,loadOnce:true,closable:false,});this.formPanel.load(tabInfo.url);var mgr=this.formPanel.getUpdateManager();mgr.on('update',this.onLoadPanel.createDelegate(this,[this.formPanel],true));}else{this.formPanel.setTitle(tabInfo.title);this.formPanel.load(tabInfo.url);}
return this.formPanel;},createAddressTab:function(tabInfo){this.addressesLoaded=false;if(!this.addressPanel){this.addressLayout=new Ext.BorderLayout(this.editLayout.getEl().createChild({tag:'div'}),{hideOnLayout:true,west:{split:true,initialSize:300,autoScroll:true,titlebar:false,collapsible:false},center:{autoScroll:true,titlebar:false,resizeTabs:true,tabPosition:'top'}});this.addressViewLayout=new Ext.BorderLayout(this.addressLayout.getRegion('west').getEl().createChild({tag:'div'}),{hideOnLayout:true,north:{split:false,initialSize:27,autoScroll:true,titlebar:false,collapsible:false},center:{split:true,initialSize:300,autoScroll:true,titlebar:false,collapsible:false}});var toolbarCPEl=this.addressViewLayout.getRegion('north').getEl().createChild({tag:'div'});var toolbar=new Ext.Toolbar(toolbarCPEl.createChild({tag:'div'}));toolbar.add({text:'New',cls:'x-btn-text-icon',handler:this.onAddressNew.createDelegate(this)},{text:'Save',cls:'x-btn-text-icon',handler:this.onAddressSave.createDelegate(this)},{text:'Delete',cls:'x-btn-text-icon',handler:this.onAddressDelete.createDelegate(this)},{text:'Reset',cls:'x-btn-text-icon',handler:this.onAddressReset.createDelegate(this)},'-');this.addressLoading=toolbar.addButton({tooltip:'Form is updating',cls:"x-btn-icon x-grid-loading",disabled:false,handler:function(){if(this.addressView){this.addressView.load({url:this.addressViewUrl+'id/'+this.customerCardId+'/',scripts:false});}},scope:this});var addressPanelInnerToolbar=this.addressViewLayout.add('north',new Ext.ContentPanel(toolbarCPEl,{toolbar:toolbar}));var addressPanelInner=this.addressViewLayout.add('center',new Ext.ContentPanel(Ext.id(),{autoCreate:true}));this.addressLayout.add('west',new Ext.NestedLayoutPanel(this.addressViewLayout));this.addressLayout.add('center',new Ext.ContentPanel(Ext.id(),{autoCreate:true,loadOnce:true}));var addressBody=addressPanelInner.getEl().createChild({tag:'div'});this.addressTemplate=new Ext.Template('<div id="{address_id}" class="address-view"><address>{address}</address></div>');this.addressTemplate.compile();this.addressView=new Ext.JsonView(addressBody,this.addressTemplate,{singleSelect:true,jsonRoot:'addresses',emptyText:'<div class="address-view"><h3>No address found</h3></div>'});this.addressView.on({'load':function(){this.addressView.select(0);this.onClickAddressView(this.addressView,0,this.addressView.getSelectedNodes()[0]);},'loadexception':function(view,data,response){alert('loadExceptionEvent');},'click':this.onClickAddressView.createDelegate(this),scope:this});this.addressPanel=new Ext.NestedLayoutPanel(this.addressLayout,{closable:false,background:!tabInfo.active,title:'Addresses'});this.addressPanel.on('activate',function(){if(this.addressesLoaded==false){this.addressView.load({url:this.addressViewUrl+'id/'+this.customerCardId+'/',scripts:false});this.addressesLoaded=true;}}.createDelegate(this));}
return this.addressPanel;},disableToolbar:function(){var toolbar=this.editLayout.getRegion('north').getActivePanel().getToolbar();for(var i=0;i<toolbar.items.length;i++){if(toolbar.items.get(i).disable){toolbar.items.get(i).disable();}}},enableToolbar:function(){var toolbar=this.editLayout.getRegion('north').getActivePanel().getToolbar();for(var i=0;i<toolbar.items.length;i++){if(toolbar.items.get(i).enable){toolbar.items.get(i).enable();}}},disableAddressToolbar:function(){var toolbar=this.addressViewLayout.getRegion('north').getActivePanel().getToolbar();for(var i=0;i<toolbar.items.length;i++){if(toolbar.items.get(i).disable){toolbar.items.get(i).disable();}}},enableAddressToolbar:function(){var toolbar=this.addressViewLayout.getRegion('north').getActivePanel().getToolbar();for(var i=0;i<toolbar.items.length;i++){if(toolbar.items.get(i).enable){toolbar.items.get(i).enable();}}},onClickAddressView:function(view,index,node,e){if(view.jsonData.length>0){this.addressView.select(index);var panel=this.addressLayout.getRegion('center').getActivePanel();panel.setUrl(this.addressViewForm+'id/'+node.id+'/customer/'+this.customerCardId);panel.refresh();}
if(this.customerCardId==0){this.addressPanel.getLayout().getRegion('center').getActivePanel().setContent('');}},onLoadException:function(v,o){this.view.getEl().update('<div style="padding:10px;">Error loading images.</div>');},onRemovePanel:function(region,panel){region.clearPanels();},onCancelEdit:function(){this.customerLayout.getRegion('south').clearPanels();},onDelete:function(){this.disableToolbar();var cb={success:this.onDeleteSuccess.createDelegate(this),failure:this.onDeleteFailure.createDelegate(this)}
var con=new Ext.lib.Ajax.request('GET',this.deleteUrl+'id/'+this.customerCardId+'/',cb);},onDeleteSuccess:function(){this.onCancelEdit();if(this.gridPanel){this.gridPanel.getGrid().getDataSource().reload();}},onDeleteFailure:function(){alert('Customer delete failure');this.enableToolbar();},onReset:function(){var panel=this.editLayout.getRegion('center').getActivePanel();var formEl=Ext.DomQuery.selectNode('form',panel.getEl().dom);if(formEl&&this.formsEdit.indexOf(formEl.id)>=0){formEl.reset();this.formsEdit.splice(this.formsEdit.indexOf(formEl.id),1);panel.setTitle(panel.getTitle().substr(0,panel.getTitle().length-1));}},onLoadPanel:function(el,response){if(!this.formPanels.get(el.id)){return false;}
var i=0;panel=this.formPanels.get(el.id);var form=null;if(form=Ext.DomQuery.selectNode('form',panel.getEl().dom)){var el;if(!form.id){form.id=Ext.id();}
for(i=0;i<form.elements.length;i++){Ext.EventManager.addListener(form.elements[i],'change',this.onFormChange.createDelegate(this,[panel,form.id],0));}
this.forms.add(form.id,new Mage.Form(form));this.forms2Panel.add(form.id,panel);}},onFormChange:function(panel,formId,e,element,object){var i;for(i=0;i<this.formsEdit.length;i++){if(this.formsEdit[i]==formId){return false;}}
if(this.forms.get(formId)){panel.setTitle(panel.getTitle()+'*');this.formsEdit.push(formId);}
e.stopEvent();},onAddressNew:function(){var panel=this.addressLayout.getRegion('center').getActivePanel();panel.setUrl(this.addressViewForm+'id/0/customer/'+this.customerCardId);panel.refresh();},onAddressSave:function(){this.disableAddressToolbar();var panel=this.addressLayout.getRegion('center').getActivePanel();var formEl=Ext.DomQuery.selectNode('form',panel.getEl().dom);var form=new Mage.Form(formEl);form.sendForm(this.onAddressSaveCallback.createDelegate(this));},onAddressSaveCallback:function(response,type){this.addressView.refresh();this.enableAddressToolbar();},onAddressDelete:function(){this.disableAddressToolbar();var selNode=this.addressView.getSelectedNodes()[0]
if(selNode){var addressId=selNode.id;var cb={success:this.onAddressDeleteSuccess.createDelegate(this),failure:this.onAddressDeleteFailure.createDelegate(this),argument:{"addressId":this.addressView.getSelectedIndexes()[0]}}
var con=new Ext.lib.Ajax.request('GET',this.deleteAddressUrl+'id/'+addressId+'/',cb);}else{this.enableAddressToolbar();}},onAddressDeleteSuccess:function(response){var addressIndex=response.argument.addressId;this.addressView.jsonData.splice(addressIndex,1);this.addressView.refresh();if(this.addressView.jsonData.length>0){this.addressView.select(0)
this.onClickAddressView(this.addressView,0,this.addressView.getSelectedNodes()[0]);}else{var panel=this.addressLayout.getRegion('center').getActivePanel();panel.setContent('');}
this.enableAddressToolbar();},onAddressDeleteFailure:function(){alert('Delete Failure');this.enableAddressToolbar();},onAddressReset:function(){var panel=this.addressLayout.getRegion('center').getActivePanel();var formEl=Ext.DomQuery.selectNode('form',panel.getEl().dom);formEl.reset();}}}();

Mage.Menu_Customer=function(){var menu;return{init:function(){menu=new Ext.menu.Menu({id:'mainCustomerMenu',items:[new Ext.menu.Item({text:'Manage Customers',handler:Mage.Customer.loadMainPanel.createDelegate(Mage.Customer)})]});Mage.Core.addLeftToolbarItem({cls:'x-btn-text-icon .btn-customer',text:'Customers',menu:menu});}}}();Mage.Menu_Customer.init();

Mage.Catalog_Product_ProductSelect=function(config){this.gridPageSize=30;this.gridUrl='/';this.loaded=false;if(config&&config.el){this.el=config.el;}else{this.el=Ext.DomHelper.append(document.body,{tag:'div'},true);}
Ext.apply(this,config);this.dialog=new Ext.LayoutDialog(this.el,{modal:true,width:600,height:450,shadow:true,minWidth:500,minHeight:350,autoTabs:true,proxyDrag:true,center:{tabPosition:"top",alwaysShowTabs:false}});this.layout=this.dialog.getLayout();var innerLayout=new Ext.BorderLayout(this.layout.getEl().createChild({tag:'div'}),{west:{initialSize:200,autoScroll:true,split:true},center:{autoScroll:true}});innerLayout.beginUpdate();var treePanel=innerLayout.add("west",new Ext.ContentPanel(innerLayout.getEl().createChild({tag:'div'})));var treeContainer=treePanel.getEl().createChild({tag:'div'});this.tree=new Ext.tree.TreePanel(treeContainer,{animate:true,loader:new Ext.tree.TreeLoader({dataUrl:Mage.url+'mage_catalog/category/treeChildren/'}),enableDD:false,containerScroll:true,rootVisible:true});var mask=new Ext.LoadMask(innerLayout.getRegion('west').getEl(),{store:this.tree});var sm=this.tree.getSelectionModel();sm.on('selectionchange',function(){var node=sm.getSelectedNode();this.loadGrid({catId:node.id});}.createDelegate(this));var root=new Ext.tree.AsyncTreeNode({id:1,text:'Catalog Categories',draggable:false,expanded:false});this.tree.setRootNode(root);this.tree.render();var dataRecord=Ext.data.Record.create([{name:'id',mapping:'product_id'},{name:'name',mapping:'name'},{name:'price',mapping:'price'},{name:'description',mapping:'description'}]);var dataReader=new Ext.data.JsonReader({root:'items',totalProperty:'totalRecords',id:'product_id'},dataRecord);var dataStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.gridUrl}),reader:dataReader,remoteSort:true});var colModel=new Ext.grid.ColumnModel([{header:"ID#",sortable:true,locked:false,dataIndex:'id'},{header:"Name",sortable:true,dataIndex:'name'},{header:"Price",sortable:true,renderer:Ext.util.Format.usMoney,dataIndex:'price'},{header:"Description",sortable:false,dataIndex:'description'}]);this.grid=new Ext.grid.Grid(innerLayout.getRegion('center').getEl().createChild({tag:'div'}),{ds:dataStore,cm:colModel,autoSizeColumns:true,loadMask:true,monitorWindowResize:true,autoHeight:false,selModel:new Ext.grid.RowSelectionModel({singleSelect:false}),enableColLock:false});innerLayout.add("center",new Ext.GridPanel(this.grid));this.grid.render();var gridHead=this.grid.getView().getHeaderPanel(true);var gridFoot=this.grid.getView().getFooterPanel(true);var paging=new Ext.PagingToolbar(gridHead,this.grid.getDataSource(),{pageSize:this.gridPageSize,displayInfo:true,displayMsg:'Products {0} - {1} of {2}',emptyMsg:'No items to display'});innerLayout.endUpdate(true);this.loadGrid=function(config){if(!config||!config.catId){var catId=1;}else{var catId=config.catId;}
this.grid.getDataSource().proxy.getConnection().url=this.gridUrl+'category/'+catId+'/';this.grid.getDataSource().load();};this.layout.beginUpdate();this.layout.add("center",new Ext.NestedLayoutPanel(innerLayout));this.layout.endUpdate();this.dialog.addKeyListener(27,this.dialog.hide,this.dialog);this.dialog.setDefaultButton(this.dialog.addButton("Close",this.dialog.hide,this.dialog));this.dialog.setDefaultButton(this.dialog.addButton("Add",this.addElements.createDelegate(this)));this.dialog.on('hide',function(){this.grid.getSelectionModel().clearSelections();}.createDelegate(this));Mage.Catalog_Product_ProductSelect.superclass.constructor.call(this);};Ext.extend(Mage.Catalog_Product_ProductSelect,Ext.util.Observable,{show:function(){this.dialog.show();if(!this.loaded){this.tree.root.reload();this.loadGrid();this.loaded=true;}},hide:function(){this.dialog.hide();},addElements:function(){if(!this.parentGrid){Ext.MessageBox.alert('Error','Parent Grid is not Set');return false;}
var sm=this.grid.getSelectionModel();var ds=this.parentGrid.getDataSource();var i=0;var data=[];for(i=0;i<ds.getCount();i++){data.push(ds.getAt(i).data.id);}
var k=0;for(i=0;i<sm.selections.items.length;i++){if(data.indexOf(sm.selections.items[i].data.id)==-1){var obj=new this.dataRecord(sm.selections.items[i].data);ds.add(obj);k++;}}
if(k==1||k==0){Ext.MessageBox.alert('Message','Added '+k+' record');}else{Ext.MessageBox.alert('Message','Added '+k+' records');}}});

Mage.Catalog=function(depend){var loaded=false;var Layout=null;return{_layouts:new Ext.util.MixedCollection(true),init:function(){var Core_Layout=Mage.Core.getLayout();if(!Layout){Layout=new Ext.BorderLayout(Ext.DomHelper.append(Core_Layout.getEl(),{tag:'div'},true),{west:{initialSize:200,split:true,autoScroll:false,collapsible:true,collapsedTitle:'Categories Tree',titlebar:true},center:{autoScroll:true,titlebar:false,tabPosition:'top',hideTabs:true,alwaysShowTabs:true}});Layout.getRegion('west').getEl().addClass('categories-tree-region');this._layouts.add('main',Layout);var Layout_West=new Ext.BorderLayout(Ext.DomHelper.append(Core_Layout.getEl(),{tag:'div'},true),{center:{split:true,initialSize:200,minSize:175,maxSize:400,collapsible:true,animate:true,autoScroll:false,useShim:true,cmargins:{top:0,bottom:2,right:2,left:2}},south:{hideWhenEmpty:true,split:true,initialSize:200,minSize:50,maxSize:400,autoScroll:true,titlebar:true,collapsible:true}});this._layouts.add('tree',Layout_West);Layout_West.beginUpdate();Mage.Catalog_Category_Tree.create();Layout_West.endUpdate();Layout.beginUpdate();Layout.add('west',new Ext.NestedLayoutPanel(Layout_West,{title:'<strong>Catalog</strong>'}));Layout.endUpdate();Core_Layout.beginUpdate();Core_Layout.add('center',new Ext.NestedLayoutPanel(Layout,{title:"Products and Categories",closable:false}));Core_Layout.endUpdate();loaded=true;}else{Mage.Core.getLayout().getRegion('center').showPanel(Layout);}},getLayout:function(name){return this._layouts.get(name);},loadMainPanel:function(){this.init();}}}();

Mage.Catalog_Product=function(depend){var dep=depend;return{ds:null,grid:null,searchPanel:null,editPanel:null,formLoading:null,loadedForms:new Ext.util.MixedCollection(),activeFilters:new Ext.util.MixedCollection(true),filterButtons:new Ext.util.MixedCollection(),filterSettings:null,editablePanels:[],categoryEditFormPanel:null,productLayout:null,parentProductLayout:null,gridPanel:null,productsGrid:null,productsGridPageSize:30,registeredForms:new Ext.util.MixedCollection(),newItemDialog:null,deleteProductUrl:Mage.url+'mage_catalog/product/delete/',init:function(){dep.init();},initLayouts:function(){var Layout=dep.getLayout('main');var Layout_Center=new Ext.BorderLayout(Ext.DomHelper.append(Layout.getEl(),{tag:'div'},true),{center:{titlebar:true,autoScroll:true,resizeTabs:true,hideTabs:true,tabPosition:'top'}});Layout_Center.getRegion('center').getEl().addClass('products-grid-region');this.productLayout=new Ext.BorderLayout(Layout.getEl().createChild({tag:'div'}),{north:{hideWhenEmpty:true,titlebar:false,split:true,initialSize:27,minSize:27,maxSize:27,autoScroll:true,collapsible:true},center:{titlebar:false,autoScroll:true,resizeTabs:true,hideTabs:false,tabPosition:'top'},south:{hideWhenEmpty:true,split:true,initialSize:300,minSize:50,titlebar:true,autoScroll:true,collapsible:true,preservePanel:false,hideTabs:true}});this.productLayout.getRegion('south').getEl().addClass('product-form-region');Layout_Center.beginUpdate();this.parentProductLayout=Layout_Center.add('center',new Ext.NestedLayoutPanel(this.productLayout,{title:'Cat Name'}));Layout_Center.endUpdate();Layout.add('center',new Ext.NestedLayoutPanel(Layout_Center,{title:'Products Grid'}));},initGrid:function(catId){var dataRecord=Ext.data.Record.create([{name:'id',mapping:'product_id'},{name:'name',mapping:'name'},{name:'price',mapping:'price'},{name:'description',mapping:'description'}]);var dataReader=new Ext.data.JsonReader({root:'items',totalProperty:'totalRecords',id:'product_id'},dataRecord);var dataStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:Mage.url+'mage_catalog/product/gridData/category/'+catId+'/'}),reader:dataReader,remoteSort:true});dataStore.on('load',function(){if(!this.filterSettings){this.loadFilterSettings();}}.createDelegate(this));dataStore.setDefaultSort('product_id','desc');var colModel=new Ext.grid.ColumnModel([{header:"ID#",sortable:true,locked:false,dataIndex:'id'},{header:"Name",sortable:true,dataIndex:'name'},{header:"Price",sortable:true,renderer:Ext.util.Format.usMoney,dataIndex:'price'},{header:"Description",sortable:false,dataIndex:'description'}]);this.productsGrid=new Ext.grid.Grid(this.productLayout.getEl().createChild({tag:'div'}),{ds:dataStore,cm:colModel,autoSizeColumns:true,loadMask:true,monitorWindowResize:true,autoHeight:true,selModel:new Ext.grid.RowSelectionModel({singleSelect:true}),enableColLock:false});this.productsGrid.mageCategoryId=catId;this.productsGrid.on('rowclick',this.createItem.createDelegate(this));this.productsGrid.render();var gridHead=this.productsGrid.getView().getHeaderPanel(true);var gridFoot=this.productsGrid.getView().getFooterPanel(true);var paging=new Ext.PagingToolbar(gridHead,dataStore,{pageSize:this.productsGridPageSize,displayInfo:true,displayMsg:'Displaying products {0} - {1} of {2}',emptyMsg:'No products to display'});var btnAdd=new Ext.Toolbar.Button({text:'Filter',handler:this.addFilter.createDelegate(this),cls:'x-btn-text-icon btn-add',disabled:true});paging.insertButton(0,btnAdd);this.filterButtons.add('add',btnAdd);var btnApply=new Ext.Toolbar.Button({text:'Apply',handler:this.applyFilters.createDelegate(this),cls:'x-btn-text-icon btn-accept',disabled:true});paging.insertButton(1,btnApply);this.filterButtons.add('apply',btnApply);var bntReset=new Ext.Toolbar.Button({text:'Reset',handler:this.deleteFilters.createDelegate(this),cls:'x-btn-text-icon btn-delete',disabled:true});paging.insertButton(2,bntReset);this.filterButtons.add('clear',bntReset);paging.insertButton(3,{text:'Product',cls:'x-btn-text-icon btn-package-add',handler:this.createItem.createDelegate(this)});paging.insertButton(4,new Ext.Toolbar.Separator());},addFilter:function(node,e){if(this.filterSettings==null){Ext.MessageBox.alert('Filters','Filters Settings Not Loaded');return false;}
var workZoneCenterPanel=null;if(!(workZoneCenterPanel=this.productLayout.getRegion('north').getPanel('filters_panel'))){workZoneCenterPanel=this.productLayout.add('north',new Ext.ContentPanel('filters_panel',{autoCreate:true,title:'Filters',closable:true}));}
var filter=new Ext.Toolbar(workZoneCenterPanel.getEl().createChild({tag:'div',id:'filter-'+Ext.id()}));filter.add({handler:this.delFilter.createDelegate(this,[filter],0),cls:'x-btn-icon btn-cross'});var startType=null;var startComp=null;var compData={};var options=[];var i=0;for(i=0;i<this.filterSettings.getCount();i++){var record=this.filterSettings.getAt(i);if(i==0){startComp=record.data.filterComp;startType=record.data.filterType;}
compData[record.data.filterField]=record.data.filterComp;options.push({tag:'option',value:record.data.filterField,html:record.data.filterName,ftype:record.data.filterType})}
var type=filter.addDom({tag:'select',name:'filterField',id:filter.getEl().id+'-filterField',children:options});var options=[]
for(i=0;i<startComp.length;i++){options.push({tag:'option',value:startComp[i].v,html:startComp[i].n});}
var comp=filter.addDom({tag:'select',name:'filterType',id:filter.getEl().id+'-filterType',children:options});Ext.EventManager.addListener(type.getEl(),'change',function(filter,type,compEl,compData){var selectedValue=type.getEl().value;while(compEl.options.length>0){compEl.options[0]=null;}
var i=0;for(i=0;i<compData[selectedValue].length;i++){opt=compData[selectedValue][i];compEl.options[compEl.options.length]=new Option(opt.n,opt.v);}
var sType=type.getEl().options[type.getEl().options.selectedIndex].getAttribute('ftype');var lastItem=filter.items.itemAt(filter.items.getCount()-1);filter.items.remove(lastItem);lastItem.destroy();var textValue=this.createFilterTextValue(filter.getEl().id,sType);filter.addField(textValue);}.createDelegate(this,[filter,type,comp.getEl(),compData],0));var textValue=this.createFilterTextValue(filter.getEl().id,startComp);filter.addField(textValue);this.activeFilters.add(Ext.id(),filter);this.updateSizeFilterPanel();return true;},createFilterTextValue:function(filterId,sType){switch(sType){case'date':var textValue=new Ext.form.DateField({id:filterId+'-textValue',allowBlank:true});break;case'combobox':break;case'between':break;case'number':var textValue=new Ext.form.NumberField({allowNegative:false,id:filterId+'-textValue',grow:true,width:135,growMin:135,growMax:600,allowBlank:true});case'text':default:var textValue=new Ext.form.TextField({id:filterId+'-textValue',grow:true,width:135,growMin:135,growMax:600,allowBlank:true});}
return textValue;},loadFilterSettings:function(){var dataRecord=Ext.data.Record.create([{name:'filterId',mapping:'filter_id'},{name:'filterField',mapping:'filter_field'},{name:'filterName',mapping:'filter_name'},{name:'filterType',mapping:'filter_type'},{name:'filterComp',mapping:'filter_comp'}]);var dataReader=new Ext.data.JsonReader({root:'filters',totalProperty:'totalRecords',id:'filter_id'},dataRecord);this.filterSettings=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:Mage.url+'mage_catalog/product/filtersettings/',method:'POST'}),reader:dataReader,remoteSort:true});this.filterSettings.on('load',function(){var i=0;for(i=0;i<this.filterButtons.getCount();i++){var btn=this.filterButtons.itemAt(i);btn.enable();}}.createDelegate(this));this.filterSettings.load();},updateSizeFilterPanel:function(){if(!this.productLayout.getRegion('north')){return false;}
if(!(workZoneCenterPanel=this.productLayout.getRegion('north').getPanel('filters_panel'))){return false;}
var titleHeight=this.productLayout.getRegion('north').titleEl.getHeight();var filters=workZoneCenterPanel.getEl().dom.childNodes;var i=0;var height=titleHeight;if(filters.length==0){this.productLayout.getRegion('north').remove(workZoneCenterPanel);}
for(i=0;i<filters.length;i++){var el=Ext.get(filters[i]);height=height+el.getHeight();}
this.productLayout.getRegion('north').resizeTo(height+1);this.productLayout.getRegion('north').config.maxSize=height+1;return true;},applyFilters:function(){var i=0;var k=0;var filter=[];for(i=0;i<this.activeFilters.getCount();i++){var toolbar=this.activeFilters.itemAt(i);filter[i]={};filter[i].index=i;filter[i].data={};filter[i].data['filterValue']=Ext.ComponentMgr.get(toolbar.getEl().id+'-textValue').getValue();for(k=0;k<toolbar.items.getCount();k++){if(toolbar.items.itemAt(k).getEl().name=='filterType'||toolbar.items.itemAt(k).getEl().name=='filterField'){filter[i].data[toolbar.items.itemAt(k).getEl().name]=toolbar.items.itemAt(k).getEl().value;}}}
this.productsGrid.getDataSource().load({params:{start:0,limit:this.productsGridPageSize,filters:Ext.encode(filter)}});},deleteFilters:function(){var panel=this.productLayout.getRegion('north').getPanel('filters_panel');if(panel){this.productLayout.getRegion('north').remove(panel);this.productsGrid.getDataSource().load({params:{start:0,limit:this.productsGridPageSize}});}},delFilter:function(filter){for(var i=0;i<filter.items.getCount();i++){var item=filter.items.itemAt(i);filter.items.remove(item);if(item.destroy){filter.items.get(i).destroy();}}
filter.getEl().removeAllListeners();filter.getEl().remove();this.activeFilters.remove(filter);this.updateSizeFilterPanel();},viewGrid:function(config){if(!config.catId){return false;}
this.init();if(!this.productLayout){this.initLayouts();}
if(config.catTitle){this.parentProductLayout.setTitle(config.catTitle);}
if(!this.gridPanel){this.initGrid(config.catId);this.productLayout.beginUpdate();this.gridPanel=this.productLayout.add('center',new Ext.GridPanel(this.productsGrid,{title:config.catTitle}));this.productLayout.endUpdate();if(config.load){this.productsGrid.getDataSource().load({params:{start:0,limit:this.productsGridPageSize}});}}else{this.gridPanel.getGrid();this.productsGrid.getDataSource().proxy.getConnection().url=Mage.url+'mage_catalog/product/gridData/category/'+config.catId+'/';if(config.load&&this.productsGrid.mageCategoryId!=config.catId){this.productsGrid.getDataSource().load({params:{start:0,limit:this.productsGridPageSize}});}
this.productsGrid.mageCategoryId=config.catId;}},setUpNewItem:function(menuItem,e){if(!this.newItemDialog){this.newItemDialog=new Ext.BasicDialog(Ext.DomHelper.append(document.body,{tag:'div'},true),{title:'Test',autoTabs:true,width:300,height:200,modal:false,shadow:true,minWidth:300,minHeight:200,proxyDrag:true});var sbmt=this.newItemDialog.addButton('Ok',submit,this);sbmt.disable();this.newItemDialog.addButton('Cancel',this.newItemDialog.hide,this.newItemDialog);var mgr=new Ext.UpdateManager(this.newItemDialog.body);mgr.on('update',function(){sbmt.enable()});mgr.update(Mage.url+'mage_catalog/product/create/');}
this.newItemDialog.show(menuItem.getEl().dom);var dialog=this.newItemDialog;function submit(){var set=Ext.DomQuery.selectNode('select#choose_attribute_set',dialog.body.dom);var type=Ext.DomQuery.selectNode('select#choose_product_type',dialog.body.dom);if(set){var setId=set.value;}
if(type){var typeId=type.value;}
this.newItemDialog.hide();this.doCreateItem.createDelegate(this,[-1,'yes',setId,typeId],0)();}},createItem:function(){var rowId=null;var menuItem=null;var e=null;switch(arguments.length){case 2:menuItem=arguments[0];e=arguments[1];rowId=0;if(this.editablePanels.length){Ext.MessageBox.confirm('Product Card','You have unsaved product. Do you whant continue ?',this.setUpNewItem.createDelegate(this,[menuItem,e],0));}else{this.setUpNewItem(menuItem,e);return true;}
break;case 3:rowId=arguments[1];e=arguments[2];if(this.editablePanels.length){Ext.MessageBox.confirm('Product Card','You have unsaved product. Do you whant continue ?',this.doCreateItem.createDelegate(this,[rowId],0));}else{if(rowId>=0){try{prodId=this.productsGrid.getDataSource().getAt(rowId).id;}catch(e){Ext.MessageBox.alert('Error!',e.getMessage());}}
this.doCreateItem(prodId,'yes');return true;}
break;default:return false;};},doCreateItem:function(prodId,btn,setId,typeId){setId=Number(setId);typeId=typeId;if(btn=='no'){return false;}
if(prodId){var title='Product #'+prodId;}
else{var title='New Product';}
if(this.productLayout.getRegion('south').getActivePanel()){this.productLayout.getRegion('south').clearPanels();this.editablePanels=[];}
this.editPanel=new Ext.BorderLayout(this.productLayout.getEl().createChild({tag:'div'}),{hideOnLayout:true,north:{split:false,initialSize:28,minSize:28,maxSize:28,autoScroll:false,titlebar:false,collapsible:false},center:{autoScroll:true,titlebar:false,resizeTabs:true,preservePanel:false,autoDestroy:true,tabPosition:'top'}});this.editPanel.getRegion('center').on('beforeremove',function(region,panel,e){}.createDelegate(this));this.editPanel.add('north',new Ext.ContentPanel(this.productLayout.getEl().createChild({tag:'div'})));this.productLayout.beginUpdate();var failure=function(o){Ext.MessageBox.alert('Product Card',o.statusText);}
var cb={success:this.loadTabs.createDelegate(this),failure:failure,argument:{prod_id:prodId}};var con=new Ext.lib.Ajax.request('GET',Mage.url+'mage_catalog/product/card/product/'+prodId+'/setid/'+setId+'/type/'+typeId+'/',cb);this.productLayout.add('south',new Ext.NestedLayoutPanel(this.editPanel,{closable:true,title:title}));this.productLayout.getRegion('south').on('panelremoved',this.onRemovePanel.createDelegate(this));this.productLayout.endUpdate();},onRemovePanel:function(region,panel){this.editablePanels=[];this.registeredForms.clear();if(region&&panel){panel.getLayout().getRegion('center').clearPanels();}else{this.productLayout.getRegion('south').getActivePanel().getLayout().getRegion('center').clearPanels();}
this.productLayout.getRegion('south').clearPanels();return true;},onResetForm:function(){var i;for(i=0;i<this.editablePanels.length;i++){var panel=this.editPanel.getRegion('center').getPanel(this.editablePanels[i]);if(form=Ext.DomQuery.selectNode('form',panel.getEl().dom)){form.reset();}
panel.setTitle(panel.getTitle().substr(0,panel.getTitle().length-1));}
this.editablePanels=[];return true;},onCancelEdit:function(){if(this.editablePanels.length){Ext.MessageBox.confirm('Product Card','You have unsaved product. Do you whant continue ?',this.onRemovePanel.createDelegate(this));}else{this.onRemovePanel();}
return true;},saveItem:function(){var region=this.editPanel.getRegion('center');var i=0;var k=0;var panel=null;var form=null;for(i=0;i<region.panels.length;i++){panel=region.panels.get(i);dq=Ext.DomQuery;form=null;if(panel.loaded){formEl=dq.selectNode('form',panel.getEl().dom);if(!formEl||!formEl.action){continue;}
if(form=this.registeredForms.get(formEl.action)){form.appendForm(formEl);}else{form=new Mage.Form(formEl);this.registeredForms.add(form.action,form);}}}
form=null;for(i=0;i<this.registeredForms.getCount();i++){form=this.registeredForms.itemAt(i);form.sendForm(this.saveItemCallBack.createDelegate(this));}},saveItemCallBack:function(response,type){var result=Ext.decode(response.responseText);if(result.error==0){var i;for(i=0;i<this.editablePanels.length;i++){var panel=this.editPanel.getRegion('center').getPanel(this.editablePanels[i]);panel.setTitle(panel.getTitle().substr(0,panel.getTitle().length-1));}
this.editablePanels=[];}else{Ext.MessageBox.alert('Error',result.errorMessage);}},onDeleteItem:function(){var sm=this.productsGrid.getSelectionModel();var ds=this.productsGrid.getDataSource();var conn=new Ext.data.Connection();conn.on('requestcomplete',function(trId,response,options){var result=Ext.decode(response.responseText);if(result.error===0){ds.remove(sm.selections.items[0]);}else{Ext.MessageBox.alert('Error',result.errorMessage);}});conn.on('requestexception',function(){Ext.MessageBox.alert('Critical Error','requestexception');});conn.request({url:this.deleteProductUrl,params:{id:sm.selections.items[0].id},method:"POST"});},loadTabs:function(response){if(!this.editPanel){return false;}
dataCard=Ext.decode(response.responseText);this.editPanel.beginUpdate();var toolbar=new Ext.Toolbar(Ext.DomHelper.insertFirst(this.editPanel.getRegion('north').getEl().dom,{tag:'div'},true));toolbar.add({text:'Save',cls:'x-btn-text-icon btn-accept',handler:this.saveItem.createDelegate(this)},{text:'Delete',cls:'x-btn-text-icon btn-bin-closed',handler:function(e){Ext.MessageBox.confirm('Delete Product','Are you sure ?!',function(btn,text){if(btn=='yes'){this.onDeleteItem();}},this)}.createDelegate(this)},{text:'Reset',cls:'x-btn-text-icon btn-arrow-undo',handler:this.onResetForm.createDelegate(this)},{text:'Cancel',cls:'x-btn-text-icon btn-cancel',handler:this.onCancelEdit.createDelegate(this)},'-');this.formLoading=toolbar.addButton({tooltip:'Form is updating',cls:"x-btn-icon x-grid-loading",disabled:false});toolbar.addSeparator();var panel=null;for(var i=0;i<dataCard.tabs.length;i++){var panel=this.createTabPanel(dataCard.tabs[i]);if(panel){var mgr=panel.getUpdateManager();mgr.on('update',this.onLoadPanel.createDelegate(this,[panel],true));this.editPanel.add('center',panel);}}
for(var i=0;i<dataCard.tabs.length;i++){if(dataCard.tabs[i].active){this.editPanel.getRegion('center').showPanel('productCard_'+dataCard.tabs[i].name);}}
this.editPanel.endUpdate();return true;},createTabPanel:function(tabInfo){var panel=null;if(tabInfo.type){switch(tabInfo.type)
{case'related':panel=Mage.Catalog_Product_RelatedPanel.create({panel:this.editPanel,tabInfo:tabInfo});break;case'bundle':panel=Mage.Catalog_Product_BundlePanel.create({panel:this.editPanel,tabInfo:tabInfo});break;case'super':panel=Mage.Catalog_Product_SuperPanel.create({panel:this.editPanel,tabInfo:tabInfo});break;case'categories':panel=Mage.Catalog_Product_CategoriesPanel.create({panel:this.editPanel,tabInfo:tabInfo});break;}}
else{panel=new Ext.ContentPanel('productCard_'+tabInfo.name,{title:tabInfo.title,autoCreate:true,closable:false,url:tabInfo.url,loadOnce:true,background:true});}
return panel;},onLoadPanel:function(el,response){var i=0;panel=this.editPanel.getRegion('center').getPanel(el.id);if(!panel){return false;}
date=[];if(form=Ext.DomQuery.selectNode('form',panel.getEl().dom)){var el;for(i=0;i<form.elements.length;i++){if(form.elements[i]){Ext.EventManager.addListener(form.elements[i],'change',this.onFormChange.createDelegate(this,[panel],true));}}
this.loadedForms.add(form.id,form);}},onFormChange:function(e,element,object,panel){var i=0;for(i=0;i<this.editablePanels.length;i++){if(this.editablePanels[i]==panel.getId()){e.stopEvent();return true;}}
this.editablePanels.push(panel.getId());panel.setTitle(panel.getTitle()+'*');e.stopEvent();},loadCategoryEditForm:function(treeNode){if(!this.categoryEditFormPanel){var workZone=dep.getLayout('main');workZone.beginUpdate();this.categoryEditFormPanel=workZone.add('center',new Ext.ContentPanel('',{autoCreate:true,url:Mage.url+'mage_catalog/category/new/',title:'Edit: '+treeNode.text,background:true}));workZone.endUpdate();}else{this.categoryEditFormPanel.setTitle('Edit: '+treeNode.text);}}}}(Mage.Catalog);Mage.Catalog_Product_CategoriesPanel=function(){return{rowTemplate:null,dataUrl:Mage.url+'mage_catalog/product/categoryList/',create:function(config){this.config=config;if(!config.panel||!config.tabInfo){return false;}
Ext.apply(this,config);var baseEl=this.panel.getRegion('center').getEl().createChild({tag:'div',id:'productCard_'+this.tabInfo.name});var tb=new Ext.Toolbar(baseEl.createChild({tag:'div'}));tb.add({text:'Delete',cls:'x-btn-text-icon'});this.rowTemplate=new Ext.Template('<div class="address-view" id="product-category-{category_id}">{name}</div>');this.rowTemplate.compile();this.cPanel=new Ext.ContentPanel(baseEl,{title:this.tabInfo.title,toolbar:tb,autoCreate:true,closable:false,loadOnce:true,background:true});var container=this.cPanel.getEl().createChild({tag:'div'});this.categoriesView=new Ext.JsonView(container,this.rowTemplate,{singleSelect:true,jsonRoot:'items',emptyText:'<div class="address-view" id="product-categories-view-empty"><h3>Empty</h3></div>'});var productId=Mage.Catalog_Product.productsGrid.getSelectionModel().selections.items[0].id;this.cPanel.on('activate',function(){if(!this.dataLoaded){this.categoriesView.load({url:this.dataUrl+'product/'+productId,scripts:false});this.dataLoaded=true;}}.createDelegate(this));dd=new Ext.dd.DragDrop(this.categoriesView.getEl(),"TreeDD");var dropzone=new Ext.dd.DropTarget(container,{});dropzone.notifyDrop=function(n,dd,e,data){return true;}
return this.cPanel;}}}();

Mage.Catalog_Product_Attributes=function(){var loaded=false;var Layout=null;return{westLayout:null,btnEdit:null,btnDelete:null,attributeGrid:null,attributeGridToolbar:null,attributeGridUrl:Mage.url+'mage_catalog/product/attributeList/',attributeGridPropUrl:Mage.url+'mage_catalog/product/attributePropList/',attributesDeleteUrl:Mage.url+'mage_catalog/product/attributeDelete/',attributesCreateUrl:Mage.url+'mage_catalog/product/attributeCreate/',attributesCommitUrl:Mage.url+'mage_catalog/product/attributeSave/',addGroupAttributes:Mage.url+'mage_catalog/product/addGroupAttributes/',removeElementUrl:Mage.url+'mage_catalog/product/removElement/',saveSetUrl:Mage.url+'mage_catalog/product/saveSet/',saveGroupUrl:Mage.url+'mage_catalog/product/saveGroup/',setTreeUrl:Mage.url+'mage_catalog/product/attributeSetTree/',moveNodeUrl:Mage.url+'mage_catalog/product/moveAttributeInSet/',setGrid:null,setGridUrl:Mage.url+'mage_catalog/product/attributeSetList/',editSetGrid:null,editSetGridUrl:Mage.url+'mage_catalog/product/attributesetproperties/',stree:null,init:function(){var Core_Layout=Mage.Core.getLayout();if(!Layout){Layout=new Ext.BorderLayout(Ext.DomHelper.append(Core_Layout.getEl(),{tag:'div'},true),{west:{split:true,initialSize:300,autoScroll:false,collapsible:false,titlebar:false},center:{autoScroll:false,titlebar:false,hideTabs:false,tabPosition:'top'}});this.westLayout=new Ext.BorderLayout(Layout.getRegion('west').getEl().createChild({tag:'div'}),{center:{split:true,autoScroll:false,collapsible:false,titlebar:false},south:{split:true,hideWhenEmpty:true,initialSize:200,autoScroll:false,collapsible:false,titlebar:false,hideTabs:true}});this.initSetTree();Layout.beginUpdate();Layout.add('west',new Ext.NestedLayoutPanel(this.westLayout));Layout.endUpdate();Core_Layout.beginUpdate();Core_Layout.add('center',new Ext.NestedLayoutPanel(Layout,{title:"Product Attributes",closable:false}));Core_Layout.endUpdate();this.loadAttributeGrid();}else{Mage.Core.getLayout().getRegion('center').showPanel(Layout);}},initSetTree:function(){var sseed=0;var gseed=0;var sview=Ext.DomHelper.append(Layout.getEl().dom,{cn:[{id:'main-tb'},{id:'sbody'}]});var tb=new Ext.Toolbar('main-tb');tb.add({id:'add',text:'Set',handler:addSet,cls:'x-btn-text-icon b btn-add',tooltip:'Add a new Set to the product attributes'},{id:'group',text:'Group',disabled:true,handler:addGroup,cls:'x-btn-text-icon btn-add',tooltip:'Add a new group to the selected component'},'-',{id:'remove',text:'Remove',disabled:true,handler:removeHandler.createDelegate(this),cls:'x-btn-text-icon btn-delete',tooltip:'Remove the selected item'},'-',{id:'reload',text:'Reload',disabled:false,handler:refreshTree,cls:'x-btn-text-icon btn-arrow-refresh',tooltip:'Remove the selected item'});var btns=tb.items.map;this.westLayout.beginUpdate();this.westLayout.add('center',new Ext.ContentPanel(sview,{autoScroll:true,fitToFrame:true,toolbar:tb,resizeEl:'sbody'}));this.westLayout.endUpdate();var stree=new Ext.tree.TreePanel('sbody',{animate:true,enableDD:true,containerScroll:true,lines:false,rootVisible:false,loader:new Ext.tree.TreeLoader({dataUrl:this.setTreeUrl})});this.stree=stree;stree.on('nodedragover',function(e){var ta=e.target.attributes;if(!e.dropNode){if((ta.type=='group'&&e.point=='append')||(ta.type=='attribute'&&e.point!='append')){return true;}else{return false;}}
if(ta.isGeneral&&e.point==='above'){return false;}
var na=e.dropNode.attributes;if((na.setId===ta.setId&&na.type=='group'&&ta.type=='set'&&e.point=='append')||(na.setId===ta.setId&&na.type=='group'&&ta.type=='group'&&e.point!='append')||(na.setId===ta.setId&&na.type=='attribute'&&ta.type=='group'&&e.point=='append'&&na.groupId!=ta.groupId)||(na.setId===ta.setId&&na.type=='attribute'&&ta.type=='attribute'&&e.point!='append')){return true;}else{return false;}});stree.on('beforenodedrop',function(e){var data={};data.point=e.point;switch(e.point){case'above':data.pid=e.target.parentNode.id;if(e.target.previousSibling){data.aid=e.target.previousSibling.id;}else{data.aid=0;}
break;case'below':data.pid=e.target.parentNode.id;data.aid=e.target.id;break;case'append':data.pid=e.target.id;if(e.target.lastChild){data.aid=e.target.lastChild.id;}else{data.aid=0;}
break;default:e.cancel=true;return e;}
if(e.dropNode){data.id=e.dropNode.id;var success=function(o){na=e.dropNode.attributes;tpa=e.target.parentNode.attributes;if(na.groupId!=tpa.groupId){na.id='set:'+na.setId+'/group:'+tpa.groupId+'/attr:'+na.attributeId;}};var failure=function(o){Ext.dump(o.statusText);};var pd=[];for(var key in data){pd.push(encodeURIComponent(key),"=",encodeURIComponent(data[key]),"&");}
pd.splice(pd.length-1,1);var con=new Ext.lib.Ajax.request('POST',this.moveNodeUrl,{success:success,failure:failure,scope:e},pd.join(""));return true;}
var s=e.data.selections,r=[],flag=false;for(var i=0,len=s.length;i<len;i++){var attributeId=s[i].data.attribute_id;var res=[];var node=null;if(e.point==='append'){node=e.target.parentNode;}else{node=e.target.parentNode.parentNode;}
if(node===null){return false;}
node.cascade(function(){if(this.attributes.attributeId==attributeId){flag=true;res.push(this);}});if(res.length==0){var node=new Ext.tree.TreeNode({allowDrop:false,allowDrag:true,allowEdit:false,allowDelete:false,type:'dropped',cls:'x-tree-node-loading',text:s[i].data.attribute_code,setId:e.target.attributes.setId,groupId:e.target.attributes.groupId,attributeId:attributeId,iconCls:'attr',leaf:true,allowChildren:false});r.push(node);}}
if(flag==true){Ext.MessageBox.alert('Warning','Some of attributes already exist in this set and weren\'t added.');}
if(r.length>0){var conn=new Ext.data.Connection();conn.on('requestcomplete',function(conn,response,options){var i=0;try{var result=Ext.decode(response.responseText);if(result.error===0){for(i=0;i<r.length;i++){r[i].attributes.type='attribute';r[i].attributes.allowDelete=true;r[i].ui.removeClass('x-tree-node-loading');}}else{for(i=0;i<r.length;i++){if(result.errorNodes.indexOf(r[i].attributes.attributeId)>=0){r[i].parentNode.removeChild(r[i]);}}
Ext.MessageBox.alert('Error',result.errorMessage);}}catch(e){for(i=0;i<r.length;i++){r[i].parentNode.removeChild(r[i]);}
Ext.MessageBox.alert('Critical Error',response.responseText);}});conn.on('requestexception',function(){Ext.MessageBox.alert('Critical Error','Request Eception');});var requestParams={};requestParams.groupId=e.target.attributes.groupId;var groupAttributes=[];for(var i in r){if(r[i].attributes&&r[i].attributes.attributeId){groupAttributes.push(r[i].attributes.attributeId);}}
requestParams.attributes=Ext.encode(groupAttributes);requestParams.point=e.point;requestParams.sibling=-1;if(e.point=='below'){requestParams.sibling=e.target.attributes.attributeId;}else if(e.point=='above'){if(e.target.previousSibling){requestParams.sibling=e.target.previousSibling.attributes.attributeId;}else{requestParams.sibling=-1;}}else if(e.point=='append'){if(e.target.lastChild){requestParams.sibling=e.target.lastChild.attributes.attributeId;}else{requestParams.sibling=-1;}}
conn.request({url:this.addGroupAttributes,method:"POST",params:requestParams});}else{Ext.MessageBox.alert('Error','The attribute already exists in set.');}
e.dropNode=r;e.cancel=r.length<1;}.createDelegate(this));var croot=new Ext.tree.AsyncTreeNode({allowDrag:true,allowDrop:true,id:'croot',text:'Sets',cls:'croot'});function refreshTree(){croot.reload();}
stree.setRootNode(croot);stree.render();croot.expand();var sm=stree.getSelectionModel();sm.on('selectionchange',function(){var n=sm.getSelectedNode();if(!n){btns.remove.disable();btns.group.disable();return;}
var a=n.attributes;btns.remove.setDisabled(!a.allowDelete);btns.group.setDisabled(!a.setId);});function guid(prefix){return prefix+(new Date().getTime());}
function addSet(){var id=guid('s-');var text='Set '+(++sseed);var node=createSet(id,text);node.select();ge.triggerEdit(node);}
function createSet(id,text,groups){var node=new Ext.tree.AsyncTreeNode({text:text,iconCls:'set',cls:'set',type:'set',id:id,setId:id,leaf:false,expanded:false,allowDelete:true,allowDrop:true,allowDrag:true,allowEdit:true});croot.appendChild(node);return node;}
function removeHandler(){var n=sm.getSelectedNode();if(!n){return false;}
var a=n.attributes;if(a.allowDelete){n.disable();var conn=new Ext.data.Connection();conn.on('requestcomplete',function(conn,response,options){var i=0;var result=Ext.decode(response.responseText);if(result.error===0){if(a.type=='group'){while(n.childNodes.length){n.childNodes[0].id=n.parentNode.firstChild.id+'/attr:'+n.childNodes[0].attributes.attributeId;n.parentNode.firstChild.appendChild(n.childNodes[0]);}}
n.parentNode.removeChild(n);}else{n.enable();Ext.MessageBox.alert('Error',result.errorMessage);}});conn.on('requestexception',function(){Ext.MessageBox.alert('Error','requestException');});var requestParams={};requestParams.element=a.type;switch(a.type){case'set':requestParams.setId=a.setId;break;case'group':requestParams.setId=a.setId;requestParams.groupId=a.groupId;break;case'attribute':requestParams.setId=a.setId;requestParams.groupId=a.groupId;requestParams.attributeId=a.attributeId;break;default:return false;}
conn.request({url:this.removeElementUrl,method:"POST",params:requestParams});}}
var ge=new Ext.tree.TreeEditor(stree,{allowBlank:false,blankText:'A name is required',selectOnFocus:true});ge.on('beforestartedit',function(){if(!ge.editNode.attributes.allowEdit){return false;}});ge.on('complete',function(){var node=ge.editNode;switch(node.attributes.type){case'set':var requestUrl=this.saveSetUrl;var requestParams={code:ge.getValue(),id:node.attributes.setId};break;case'group':var requestUrl=this.saveGroupUrl;var requestParams={code:ge.getValue(),setId:node.attributes.setId,id:node.attributes.groupId};break;default:return true;}
var conn=new Ext.data.Connection();conn.on('requestcomplete',function(conn,response,options){var i=0;var result=Ext.decode(response.responseText);if(result.error===0){if(result.setId){node.attributes.setId=result.setId;node.id='set:'+result.setId;node.reload();}
if(result.groupId){node.attributes.groupId=result.groupId;}}else{node.parentNode.removeChild(node);Ext.MessageBox.alert('Error',result.errorMessage);}});conn.on('requestexception',function(){Ext.MessageBox.alert('Error','requestException');});conn.request({url:requestUrl,method:"POST",params:requestParams});}.createDelegate(this));function addGroup(btn,e){var n=sm.getSelectedNode();if((typeof n.isLoaded=='function')){if(n.isLoaded()){var newnode=createGroup(n,'Group'+(++gseed));newnode.select();ge.triggerEdit(newnode);}else{n.reload(addGroup);}}else{var newnode=createGroup(n,'Group'+(++gseed));ge.triggerEdit(newnode);}}
function createGroup(n,text){var snode=stree.getNodeById('set:'+n.attributes.setId);var csetId=n.attributes.setId;var snode=null;croot.eachChild(function(node){if(node.attributes.setId==csetId){snode=node;}});var node=new Ext.tree.TreeNode({text:text,setId:n.attributes.setId,iconCls:'folder',type:'group',allowDelete:true,allowDrop:true,allowDrag:true,allowEdit:true,id:guid('o-')});snode.appendChild(node);return node;}},loadAttributeGrid:function(){if(this.attributeGrid==null){this.initAttributesGrid();Layout.beginUpdate();Layout.add('center',new Ext.GridPanel(this.attributeGrid));Layout.endUpdate();this.attributeGrid.getDataSource().load({params:{start:0,limit:10}});}else{this.attributeGrid.getDataSource().proxy.getConnection().url=this.attributeGridUrl;this.attributeGrid.getDataSource().load({params:{start:0,limit:10}});}},initAttributesGrid:function(){var dataRecord=Ext.data.Record.create([{name:'attribute_id',mapping:'attribute_id'},{name:'attribute_code',mapping:'attribute_code'},{name:'data_input',mapping:'data_input'},{name:'data_type',mapping:'data_type'},{name:'data_saver',mapping:'data_saver'},{name:'data_source',mapping:'data_source'},{name:'editable',mapping:'editable'},{name:'deletable',mapping:'deletable'},{name:'required',mapping:'required'},{name:'searchable',mapping:'searchable'},{name:'comparable',mapping:'comparable'},{name:'multiple',mapping:'multiple'}]);var dataReader=new Ext.data.JsonReader({root:'items',totalProperty:'totalRecords',id:'attribute_id'},dataRecord);var dataStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.attributeGridUrl}),reader:dataReader,remoteSort:true});dataStore.setDefaultSort('attribute_id','asc');function formatBoolean(value){return(value===true)?'Yes':'No';};var fm=Ext.form,Ed=Ext.grid.GridEditor;var codeEditor=new Ed(new fm.TextField({allowBlank:false,revertInvalid:true}));codeEditor.on('beforecomplete',function(editor,value,startvalue){if(value===''){this.attributeGrid.getDataSource().remove(editor.record);}}.createDelegate(this));var dataReader=new Ext.data.JsonReader({root:'items',totalProperty:'totalRecords',id:'attribute_id'},dataRecord);var colModel=new Ext.grid.ColumnModel([{header:"ID#",sortable:true,locked:false,dataIndex:'attribute_id'},{header:"Code",sortable:true,dataIndex:'attribute_code',editor:codeEditor},{header:"Input type",sortable:true,dataIndex:'data_input',editor:new Ed(new Ext.form.ComboBox({typeAhead:false,triggerAction:'all',mode:'remote',store:Mage.Catalog_Product_Attributes_DropDownStore.get(this.attributeGridPropUrl,'data_input'),displayField:'text',lazyRender:true}))},{header:"Data type",sortable:true,dataIndex:'data_type',editor:new Ed(new Ext.form.ComboBox({typeAhead:false,triggerAction:'all',mode:'remote',store:Mage.Catalog_Product_Attributes_DropDownStore.get(this.attributeGridPropUrl,'data_type'),displayField:'text',lazyRender:true}))},{header:"Saver",sortable:true,dataIndex:'data_saver',editor:new Ed(new Ext.form.ComboBox({typeAhead:false,triggerAction:'all',mode:'remote',store:Mage.Catalog_Product_Attributes_DropDownStore.get(this.attributeGridPropUrl,'data_saver'),displayField:'text',lazyRender:true}))},{header:"Source",sortable:true,dataIndex:'data_source',editor:new Ed(new Ext.form.ComboBox({typeAhead:false,triggerAction:'all',mode:'remote',store:Mage.Catalog_Product_Attributes_DropDownStore.get(this.attributeGridPropUrl,'data_source'),displayField:'text',lazyRender:true}))},{header:"Required",sortable:true,dataIndex:'required',renderer:formatBoolean,editor:new Ed(new fm.Checkbox())},{header:"Searchable",sortable:true,dataIndex:'searchable',renderer:formatBoolean,editor:new Ed(new fm.Checkbox())},{header:"Comparable",sortable:true,dataIndex:'comparable',renderer:formatBoolean,editor:new Ed(new fm.Checkbox())},{header:"Multiple",sortable:true,dataIndex:'multiple',renderer:formatBoolean,editor:new Ed(new fm.Checkbox())},{header:"Deletable",sortable:true,dataIndex:'deletable',renderer:formatBoolean,editor:new Ed(new fm.Checkbox())}]);var ProductAttribute=Ext.data.Record.create([{name:'attribute_id',type:'string'},{name:'attribute_code',type:'string'},{name:'data_input'},{name:'data_type'},{name:'required'}]);this.attributeGrid=new Ext.grid.EditorGrid(Ext.DomHelper.append(Layout.getEl().dom,{tag:'div'},true),{ds:dataStore,cm:colModel,loadMask:true,enableDragDrop:true,autoSizeColumns:true,monitorWindowResize:true,ddGroup:'TreeDD',trackMouseOver:false,autoHeight:true,selModel:new Ext.grid.RowSelectionModel({singleSelect:false}),enableColLock:false});this.attributeGrid.on('afteredit',function(e){if(e.record.data.attribute_id=='###'){var conn=new Ext.data.Connection();var store=this.attributeGrid.getDataSource();conn.on('requestcomplete',function(transId,response,option){var result=Ext.decode(response.responseText);if(result.error==0){e.record.data.id=result.attributeId;e.record.data.attribute_id=result.attributeId;store.commitChanges();}else{Ext.MessageBox.alert('Error',result.errorMessage);store.remove(e.record);}});conn.on('requestexception',function(transId,response,option,e){Ext.MessageBox.alert('Error','Your changes could not be saved. The entry will be rolled back.');store.rejectChanges();});conn.request({url:this.attributesCreateUrl,method:"POST",params:{attribute:Ext.encode(e.record.data)}});}}.createDelegate(this));this.attributeGrid.on('dragout',function(){alert('test');});this.attributeGrid.render();var gridHead=this.attributeGrid.getView().getHeaderPanel(true);var tb=new Ext.Toolbar(gridHead);tb.addButton({text:'New',cls:'x-btn-text-icon btn-add',handler:function(){var pa=new ProductAttribute({attribute_id:'###',attribute_code:'',data_input:'text',data_type:'decimal',required:false});this.attributeGrid.stopEditing();dataStore.insert(0,pa);this.attributeGrid.startEditing(0,1);}.createDelegate(this)});tb.addButton({text:'Save',cls:'x-btn-text-icon btn-accept',handler:this.onSaveClick.createDelegate(this)});tb.addButton({text:'Delete',cls:'x-btn-text-icon btn-bin-closed',handler:function(){var sm=this.attributeGrid.getSelectionModel();if(sm.hasSelection()){var cell=sm.selections;var i=0;var data=[];for(i=0;i<sm.selections.items.length;i++){data.push(sm.selections.items[i].id);}
var conn=new Ext.data.Connection();conn.on('requestcomplete',function(dm,response,option){var result=Ext.decode(response.responseText);if(result.error==0){while(sm.selections.items.length){this.attributeGrid.getDataSource().remove(sm.selections.items[0]);this.stree.root.reload();}}else{Ext.MessageBox.alert('Error',result.ErrorMessage);}}.createDelegate(this));conn.on('requestexception',function(dm,response,option,e){Ext.MessageBox.alert('Error','RequestException.');});conn.request({url:this.attributesDeleteUrl,method:"POST",params:{data:Ext.encode(data)}});}}.createDelegate(this)});tb.addButton({text:'Refresh',cls:'x-btn-text-icon btn-arrow-refresh',handler:function(){this.attributeGrid.getDataSource().load();}.createDelegate(this)});},onSaveClick:function(){var ds=this.attributeGrid.getDataSource();var i=0;var data={};for(i=0;i<ds.modified.length;i++){data[i]=ds.modified[i].data;}
var conn=new Ext.data.Connection();conn.on('requestcomplete',function(transId,response,option){var result=Ext.decode(response.responseText);if(result.error==0){ds.commitChanges();}else{ds.rejectChanges();Ext.MessageBox.alert('Error',result.errorMessage);}});conn.on('requestexception',function(transId,response,option,e){Ext.MessageBox.alert('Error','Your changes could not be saved. The entry will be rolled back.');ds.rejectChanges();});conn.request({url:this.attributesCommitUrl,method:"POST",params:{attributes:Ext.encode(data)}});},loadMainPanel:function(){this.init();}}}();Mage.Catalog_Product_Attributes_DropDownStore=function(){return{get:function(url,type){var store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:url}),baseParams:{type:type},remoteSort:false,reader:new Ext.data.JsonReader({root:'items',totalProperty:'totalRecords',id:'id'},Ext.data.Record.create([{name:'text'},{name:'value'},]))});return store;}}}();

Mage.Catalog_Product_RelatedPanel=function(){return{config:null,cPanel:null,grid:null,dataRecord:null,gridUrl:Mage.url+'mage_catalog/product/relatedList/',gridPageSize:30,productSelector:null,create:function(config){this.config=config;if(!config.panel||!config.tabInfo){return false;}
Ext.apply(this,config);var baseEl=this.panel.getRegion('center').getEl().createChild({tag:'div',id:'productCard_'+this.tabInfo.name});this.cPanel=new Ext.ContentPanel(baseEl,{title:this.tabInfo.title||'Related products',closable:false,url:this.tabInfo.url,loadOnce:true,background:true});this.panel.getRegion('center').on('beforeremove',function(region,panel,e){if(this.cPanel===panel){if(this.grid){this.grid.destroy(true);}}}.createDelegate(this));var um=this.cPanel.getUpdateManager();um.on('update',this.onUpdate.createDelegate(this));return this.cPanel;},onUpdate:function(){if(!this.cPanel||!this.cPanel.getEl()){return;}
var div=Ext.DomQuery.selectNode('div#relation_tab',this.cPanel.getEl().dom);if(div){this.initGrid({baseEl:Ext.get(div)});this.productSelector=new Mage.Catalog_Product_ProductSelect({gridUrl:Mage.url+'mage_catalog/product/gridData/category/1/',parentGrid:this.grid,dataRecord:this.dataRecord});this.buildGridToolbar();this.loadGrid();}},initGrid:function(config){if(!config.baseEl){return false;}
var baseEl=config.baseEl;this.dataRecord=Ext.data.Record.create([{name:'id',mapping:'product_id'},{name:'name',mapping:'name'},{name:'price',mapping:'price'},{name:'description',mapping:'description'}]);var dataReader=new Ext.data.JsonReader({root:'items',totalProperty:'totalRecords',id:'product_id'},this.dataRecord);var productId=Mage.Catalog_Product.productsGrid.getSelectionModel().selections.items[0].id;var dataStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.gridUrl+'product/'+productId+'/'}),reader:dataReader,baseParams:{pageSize:this.gridPageSize},remoteSort:true});dataStore.on('add',function(store){var i=0;var data=[];var record=null;for(i=0;i<store.getCount();i++){record=store.getAt(i);data.push(record.data.id);}
var hiddenEl=Ext.get('related_products');hiddenEl.dom.value=data.join();});dataStore.on('remove',function(store){var i=0;var data=[];var record=null;for(i=0;i<store.getCount();i++){record=store.getAt(i);data.push(record.data.id);}
var hiddenEl=Ext.get('related_products');hiddenEl.dom.value=data.join();});var colModel=new Ext.grid.ColumnModel([{header:"ID#",sortable:true,locked:false,dataIndex:'id'},{header:"Name",sortable:true,dataIndex:'name'},{header:"Price",sortable:true,renderer:Ext.util.Format.usMoney,dataIndex:'price'},{header:"Description",sortable:false,dataIndex:'description'}]);this.grid=new Ext.grid.Grid(baseEl,{ds:dataStore,cm:colModel,autoSizeColumns:true,loadMask:true,monitorWindowResize:true,autoHeight:false,selModel:new Ext.grid.RowSelectionModel({singleSelect:false}),enableColLock:false});var resizeBaseEl=new Ext.Resizable(baseEl,{wrap:true,pinned:true,width:540,height:200,minWidth:200,minHeight:50,dynamic:false});resizeBaseEl.on('resize',this.grid.autoSize,this.grid);this.grid.render();},buildGridToolbar:function(){var gridHead=this.grid.getView().getHeaderPanel(true);paging=new Ext.Toolbar(gridHead);paging.add(new Ext.ToolbarButton({text:'Select Product',handler:this.productSelector.show,scope:this.productSelector}));paging.add(new Ext.ToolbarButton({text:'Remove',handler:function(){Ext.MessageBox.confirm('Warning','Are you sure ?',function(btn,text){if(btn=='yes'){var sm=this.grid.getSelectionModel();while(sm.selections.items.length){this.grid.getDataSource().remove(sm.selections.items[0]);}}}.createDelegate(this))}.createDelegate(this)}));},loadGrid:function(){this.grid.getDataSource().load();}}}();Mage.Catalog_Product_BundlePanel=function(){return{create:function(panel,tabInfo){}}}();Mage.Catalog_Product_SuperPanel=function(){return{create:function(panel,tabInfo){}}}();

Mage.Catalog_Category_Attributes=function(){var loaded=false;var Layout=null;return{_layouts:new Ext.util.MixedCollection(true),loadAttributesPanel:function(){var Core_Layout=Mage.Core.getLayout();if(!Layout){Layout=new Ext.BorderLayout(Ext.DomHelper.append(Core_Layout.getEl(),{tag:'div'},true),{west:{split:true,autoScroll:true,collapsible:false,titlebar:false},center:{autoScroll:false,titlebar:false,hideTabs:true}});this._layouts.add('main',Layout);var Layout_West=new Ext.BorderLayout(Ext.DomHelper.append(Core_Layout.getEl(),{tag:'div'},true),{center:{autoScroll:true,titlebar:false},south:{split:true,initialSize:300,minSize:50,maxSize:400,autoScroll:true,collapsible:true}});this._layouts.add('left',Layout_West);Layout_West.beginUpdate();Layout_West.add('center',new Ext.ContentPanel('category_attr_set_panel',{autoCreate:true}));Layout_West.add('south',new Ext.ContentPanel('category_attr_set_tree_panel',{autoCreate:true,url:Mage.url+'mage_catalog/category/arrtibutesSetTree/'}));Layout_West.endUpdate();var Layout_Center=new Ext.BorderLayout(Ext.DomHelper.append(Core_Layout.getEl(),{tag:'div'},true),{center:{autoScroll:true,titlebar:false},south:{split:true,initialSize:300,minSize:50,maxSize:400,autoScroll:true,collapsible:true}});this._layouts.add('workZone',Layout_Center);Layout_Center.beginUpdate();Layout_Center.add('center',new Ext.ContentPanel('category_attributes_panel',{title:"Dashboard",loadOnce:true,autoCreate:true,url:Mage.url+'mage_catalog/category/attributesGrid/'}));Layout_Center.add('south',new Ext.ContentPanel('category_attribute_form_panel',{autoCreate:true}));Layout_Center.endUpdate();Layout.beginUpdate();Layout.add('west',new Ext.NestedLayoutPanel(Layout_West));Layout.add('center',new Ext.NestedLayoutPanel(Layout_Center));Layout.endUpdate();Core_Layout.beginUpdate();Core_Layout.add('center',new Ext.NestedLayoutPanel(Layout,{title:"Category Attributes",closable:false}));Core_Layout.endUpdate();loaded=true;this.initAttrSetGrid();}else{Mage.Core.getLayout().getRegion('center').showPanel(Layout);}},initAttrSetGrid:function(){var parentElement=this.getLayout('left').getRegion('center');var gColumn=new Ext.grid.ColumnModel([{header:"Attributes Set Name",dataIndex:'name',editor:new Ext.grid.GridEditor(new Ext.form.TextField({allowBlank:false}))}]);gColumn.defaultSortable=true;var dataRecord=Ext.data.Record.create([{name:'category_attribute_set_id',type:'int'},{name:'category_attribute_set_code',type:'string'}]);var dataStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:Mage.url+'mage_catalog/category/attributesSetGridData/'}),reader:new Ext.data.JsonReader({record:'items'},dataRecord)});var grid=new Ext.grid.EditorGrid(Ext.DomHelper.append(this.getLayout('left').getRegion('center').getEl(),{tag:'div'}),{ds:dataStore,cm:gColumn,enableColLock:false});var gridLayout=Ext.BorderLayout.create({center:{margins:{left:3,top:3,right:3,bottom:3},panels:[new Ext.GridPanel(grid)]}},Ext.DomHelper.append(this.getLayout('left').getRegion('center').getEl(),{tag:'div'}));grid.render();var gridHead=grid.getView().getHeaderPanel(true);var tb=new Ext.Toolbar(gridHead,[{text:'Add set'}]);dataStore.load();},getLayout:function(name){return this._layouts.get(name);},create:function(){}}}();

Mage.Catalog_Category=function(dep){var loaded=false;var Layout=null;return{depend:null,treeLayout:null,init:function(){this.depend=dep;},buildGrid:function(){var gridEl=this.treeLayout.getEl().createChild({tag:'div'});var propsGrid=new Ext.grid.PropertyGrid(gridEl);propsGrid.setSource({"(name)":'test',"active":true});propsGrid.render()
this.treeLayout.add('south',new Ext.GridPanel(propsGrid));}}}(Mage.Catalog);

Mage.Catalog_Category_Create=function(){var _dialog=false;var _el=null
var _config=null
var _formUrl=Mage.url+'mage_catalog/category/form/';function _init(){var flag=false;if(!_dialog){_el=Ext.DomHelper.append(document.body,{tag:'div'},true);_dialog=new Ext.LayoutDialog(_el,{modal:true,width:600,height:450,shadow:true,minWidth:500,minHeight:350,autoTabs:true,proxyDrag:true,center:{tabPosition:"top",alwaysShowTabs:true}});_dialog.addKeyListener(27,_dialog.hide,_dialog);_dialog.setDefaultButton(_dialog.addButton("Save",saveFrom));_dialog.setDefaultButton(_dialog.addButton("Close",_dialog.hide,_dialog));_buildLayouts();flag=true;}
if(_config.button){_dialog.show(_config.button._el);}else{_dialog.show();}
var panel=_dialog.getLayout().getRegion('center').getActivePanel();if(flag===false){var formUrl=_formUrl;if(_config.edit===true&&_config.activeNode){formUrl=_formUrl+'catid/'+_config.activeNode.id+'/';}
panel.setUrl(formUrl);panel.refresh();}}
function saveFrom(){var i=0;var panel=_dialog.getLayout().getRegion('center').getActivePanel();var pEl=panel.getEl();var form=Ext.DomQuery.selectNode('form',pEl.dom);console.log(form);if(form){console.log(_config);if(_config.edit===false&&_config.activeNode){var tpl=new Ext.Template('<input type="hidden" name="parentId" value="{val}">');tpl.append(form,{val:_config.activeNode.id});}else if(_config.edit===true&&_config.activeNode){var tpl=new Ext.Template('<input type="hidden" name="nodeId" value="{val}"><input type="hidden" name="edit" value="true">');tpl.append(form,{val:_config.activeNode.id});}
var um=panel.getUpdateManager();function callBack(oElement,bSuccess,oResponse){}
um.formUpdate(form,form.action,true,callBack);}else{Ext.MessageBox.alert('Critical Error','Form not found');}}
function _buildLayouts(){var layout=_dialog.getLayout();var formUrl=_formUrl
if(_config.edit===true&&_config.activeNode){formUrl=_formUrl+'catid/'+_config.activeNode.id+'/';}
layout.beginUpdate();layout.add("center",new Ext.ContentPanel(_el.createChild({tag:'div'}),{title:"New Category",fitToFrame:true,loadOnce:false,url:formUrl}));layout.endUpdate();}
function _open(){}
function _close(){_dialog.hide();}
return{show:function(cfg){_config=cfg;_init();},hide:function(){_close();}}}();

Mage.Catalog_Category_Tree=function(){var tree=null;var categoryContextMenu=null;return{loadChildrenUrl:Mage.url+'mage_catalog/category/treeChildren/',moveNodeUrl:Mage.url+'mage_catalog/category/move/',removeNodeUrl:Mage.url+'mage_catalog/category/remove/',loadWebsiteUrl:Mage.url+'mage_catalog/category/treeWebsite/',websiteListUrl:Mage.url+'mage_core/website/list/',tree:null,websiteId:null,btns:null,create:function(panel){if(!this.tree){Ext.QuickTips.init();var layout=Mage.Catalog.getLayout('tree');var baseEl=layout.getEl().createChild({tag:'div'});var tb=new Ext.Toolbar(baseEl.createChild({tag:'div'}));var treeContainer=baseEl.createChild({tag:'div'});var ds=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.websiteListUrl}),reader:new Ext.data.JsonReader({id:'value'},[{name:'value',mapping:'value'},{name:'text',mapping:'text'}])});tb.addButton({text:'Add',id:'add',disabled:true,handler:this.onAddCategory.createDelegate(this),cls:'x-btn-text-icon btn-add'});tb.addButton({text:'Edit',id:'edit',disabled:true,handler:this.onEditCategory.createDelegate(this),cls:'x-btn-text-icon btn-folder-edit'});tb.addButton({text:'Delete',id:'del',disabled:true,handler:this.deleteCategoryConfirm.createDelegate(this),cls:'x-btn-text-icon btn-delete'});this.btns=tb.items.map;categoryContextMenu=new Ext.menu.Menu({id:'category_context_menu',items:[{text:'Show Category Products',handler:this.showProducts.createDelegate(this)},'-',{text:'Add child',handler:this.onAddCategory.createDelegate(this)},{text:'Edit Catecory',handler:this.onEditCategory.createDelegate(this)},{text:'Delete Category',handler:this.deleteCategoryConfirm.createDelegate(this)}]});var treePanel=layout.add('center',new Ext.ContentPanel(baseEl,{fitToFrame:true,autoScroll:true,autoCreate:true,toolbar:tb,resizeEl:treeContainer}));var viewEl=treeContainer.createChild({tag:'div'});this.tree=new Ext.tree.TreePanel(viewEl,{animate:true,loader:new Ext.tree.TreeLoader({dataUrl:this.loadWebsiteUrl}),enableDD:true,containerScroll:true,rootVisible:false});var sm=this.tree.getSelectionModel();sm.on('selectionchange',function(){this.btns.add.setDisabled(false);if(this.tree.getSelectionModel().getSelectedNode()&&this.tree.getSelectionModel().getSelectedNode().id!='1'){this.btns.edit.setDisabled(false);this.btns.del.setDisabled(false);}else{this.btns.edit.setDisabled(true);this.btns.del.setDisabled(true);}}.createDelegate(this));this.tree.addListener('contextmenu',this.categoryRightClick,this);this.tree.addListener('click',this.categoryClick.createDelegate(this));this.tree.addListener('dblclick',this.categoryDblClick,this);this.tree.addListener('beforenodedrop',this.moveNode,this);var root=new Ext.tree.AsyncTreeNode({text:'Catalog Categories',draggable:false,expanded:false});this.tree.setRootNode(root);this.tree.render();this.loadWebsiteRoot();}},onAddCategory:function(btn,event){var sm=this.tree.getSelectionModel();Mage.Catalog_Category_Create.show({button:btn,activeNode:sm.getSelectedNode(),edit:false});},onEditCategory:function(btn,event){var sm=this.tree.getSelectionModel();Mage.Catalog_Category_Create.show({button:btn,activeNode:sm.getSelectedNode(),edit:true});},setWebsite:function(select,record){this.loadWebsiteRoot(record.id);this.websiteId=record.id;},loadWebsiteRoot:function(websiteId){this.tree.loader.dataUrl=this.loadWebsiteUrl;this.tree.loader.baseParams.website=websiteId;this.tree.root.reload();this.tree.loader.dataUrl=this.loadChildrenUrl;},addChildDialog:function(){},moveNode:function(obj){var data={id:obj.dropNode.id}
data.point=obj.point;switch(obj.point){case'above':data.pid=obj.target.parentNode.id;if(obj.target.previousSibling){data.aid=obj.target.previousSibling.id;}else{data.aid=0;}
break;case'below':data.pid=obj.target.parentNode.id;data.aid=obj.target.id;break;case'append':data.pid=obj.target.id;if(obj.target.lastChild){data.aid=obj.target.lastChild.id;}else{data.aid=0;}
break;default:obj.cancel=true;return obj;}
var success=function(o){try{eval(o.responseText);}catch(e){Ext.dump(e);}};var failure=function(o){Ext.dump(o.statusText);};var pd=[];for(var key in data){pd.push(encodeURIComponent(key),"=",encodeURIComponent(data[key]),"&");}
pd.splice(pd.length-1,1);var con=new Ext.lib.Ajax.request('POST',this.moveNodeUrl,{success:success,failure:failure,scope:obj},pd.join(""));},editNodeDialog:function(){},deleteCategoryConfirm:function(item,event){Ext.MessageBox.confirm('Tree Message','Are you sure ?',this.deleteCategory,this);},deleteCategory:function(flag){if(flag=='yes'){var node=this.tree.getSelectionModel().getSelectedNode();var success=function(o){this.parentNode.removeChild(this);};var failure=function(o){Ext.dump(o.statusText);};var con=new Ext.lib.Ajax.request('GET',this.removeNodeUrl+'id/'+node.id+'/',{success:success,failure:failure,scope:node});}},categoryRightClick:function(node,event){categoryContextMenu.selectedNode=node;node.select();categoryContextMenu.showAt(event.getXY(),categoryContextMenu.parentMenu,false);},categoryDblClick:function(){},categoryClick:function(node,e){if(categoryContextMenu){categoryContextMenu.hide();}
this.showProducts(null,e,node);},showProducts:function(item,event,selectedNode){if(selectedNode){Mage.Catalog_Product.viewGrid({load:true,catId:selectedNode.id,catTitle:selectedNode.text});}else{Mage.Catalog_Product.viewGrid({load:true,catId:item.parentMenu.selectedNode.id,catTitle:item.parentMenu.selectedNode.text});Mage.Catalog_Product.loadCategoryEditForm(item.parentMenu.selectedNode);}},addChild:function(item,event){},editCategory:function(item,event){alert('edit category');}}}();

Mage.Menu_Catalog=function(){var menu;return{init:function(){menu=new Ext.menu.Menu({id:'mainCatalogMenu',items:[new Ext.menu.Item({text:'Categories and Products',handler:Mage.Catalog.loadMainPanel.createDelegate(Mage.Catalog)}),'-',new Ext.menu.Item({text:'Product attributes',handler:Mage.Catalog_Product_Attributes.loadMainPanel.createDelegate(Mage.Catalog_Product_Attributes)})]});Mage.Core.addLeftToolbarItem({cls:'x-btn-text-icon bmenu',text:'Catalog',menu:menu});}}}();Mage.Menu_Catalog.init();

Mage.Sales=function(depend){return{layout:null,centerLayout:null,cardPanel:null,webSiteTree:null,grid:null,gridPageSize:30,gridUrl:Mage.url+'mage_sales/order/grid/',lastSelectedRecord:null,formPanel:null,formUrl:Mage.url+'mage_sales/order/form/',oTree:null,websiteCBUrl:Mage.url+'mage_core/website/list/',websitesTreeUrl:Mage.url+'mage_sales/order/tree/',init:function(){var Core_Layout=Mage.Core.getLayout();if(!this.layout){this.layout=new Ext.BorderLayout(Core_Layout.getEl().createChild({tag:'div'}),{center:{autoScroll:false,titlebar:false,hideTabs:true},west:{split:true,initialSize:200,minSize:100,maxSize:400,autoScroll:false,collapsible:true,hideTabs:true}});this.centerLayout=new Ext.BorderLayout(Core_Layout.getEl().createChild({tag:'div'}),{center:{titlebar:true,autoScroll:false,resizeTabs:true,hideTabs:true,tabPosition:'top'},south:{preservePanels:true,hideWhenEmpty:true,split:true,initialSize:300,minSize:50,titlebar:true,autoScroll:true,collapsible:true,hideTabs:true}});this.centerLayout.beginUpdate();this.initGrid({baseEl:this.centerLayout.getRegion('center').getEl().createChild({tag:'div'})})
this.centerLayout.add('center',new Ext.GridPanel(this.grid,{fitToFrame:true,title:'Orders Info'}));this.centerLayout.endUpdate();this.layout.beginUpdate();this.layout.add('center',new Ext.NestedLayoutPanel(this.centerLayout,{autoCreate:true,fitToFrame:true}));this.layout.add('west',new Ext.ContentPanel(Ext.id(),{autoCreate:true,fitToFrame:true}));this.layout.endUpdate();Core_Layout.beginUpdate();Core_Layout.add('center',new Ext.NestedLayoutPanel(this.layout,{title:"Orders",closable:false}));Core_Layout.endUpdate();this.loadWebSitesTree();}else{Mage.Core.getLayout().getRegion('center').showPanel(this.layout);}},loadMainPanel:function(){this.init();},loadWebSitesTree:function(){this.initWebSiteTree();},initWebSiteTree:function(){var layoutEl=this.layout.getEl();if(!layoutEl){return false;}
panelEl=layoutEl.createChild({children:[{id:'tree-tb'},{id:'tree-body'}]});var tb=new Ext.Toolbar('tree-tb');tb.addButton({text:'Reload',cls:'x-btn-text-icon btn-arrow-refresh',handler:function(){this.oTree.root.reload();},scope:this});var panel=this.layout.add('west',new Ext.ContentPanel(panelEl,{fitToFrame:true,autoScroll:true,resizeEl:panelEl,toolbar:tb}))
this.oTree=new Ext.tree.TreePanel(panel.getEl().createChild({id:Ext.id()}),{animate:true,enableDD:true,containerScroll:true,lines:false,rootVisible:false,loader:new Ext.tree.TreeLoader()});var sm=this.oTree.getSelectionModel();sm.on('selectionchange',function(){var node=sm.getSelectedNode();var data={};var url=this.gridUrl;if(node.attributes.siteId){url=url+'siteid/'+node.attributes.siteId+'/'}
if(node.attributes.orderStatus){url=url+'orderstatus/'+node.attributes.orderStatus+'/'}
if(node.parentNode===this.oTree.root){this.centerLayout.getRegion('center').getActivePanel().setTitle(node.text);}else{this.centerLayout.getRegion('center').getActivePanel().setTitle(node.parentNode.text+' - '+node.text);}
this.grid.getDataSource().proxy.getConnection().url=url
this.grid.getDataSource().load();}.createDelegate(this));var wsRoot=new Ext.tree.AsyncTreeNode({allowDrag:true,allowDrop:true,id:'wsroot',text:'WebSites',cls:'wsroot',loader:new Ext.tree.TreeLoader({dataUrl:this.websitesTreeUrl})});this.oTree.setRootNode(wsRoot);this.oTree.render();wsRoot.expand();},initGrid:function(config){if(!config.baseEl){return false;}
var baseEl=config.baseEl;this.dataRecord=Ext.data.Record.create([{name:'order_id',mapping:'order_id'},{name:'real_order_id',mapping:'real_order_id'},{name:'customer_id',mapping:'customer_id'},{name:'firstname',mapping:'firstname'},{name:'lastname',mapping:'lastname'},{name:'grand_total',mapping:'grand_total'},{name:'status',mapping:'status'},{name:'created_at',mapping:'created_at'},{name:'website_id',mapping:'website_id'}]);var dataReader=new Ext.data.JsonReader({root:'items',totalProperty:'totalRecords',id:'order_id'},this.dataRecord);var dataStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.gridUrl}),reader:dataReader,baseParams:{pageSize:this.gridPageSize},remoteSort:true});var colModel=new Ext.grid.ColumnModel([{header:"Order ID",sortable:true,dataIndex:'real_order_id'},{header:"Customer ID",sortable:true,dataIndex:'customer_id'},{header:"Firstname",sortable:true,dataIndex:'firstname'},{header:"Lastname",sortable:true,dataIndex:'lastname'},{header:"Grand total",sortable:true,dataIndex:'grand_total'},{header:"Status",sortable:true,dataIndex:'status'},{header:"Created at",sortable:true,dataIndex:'created_at'},{header:"Website",sortable:true,dataIndex:'website_id'}]);this.grid=new Ext.grid.Grid(baseEl,{ds:dataStore,cm:colModel,autoSizeColumns:true,loadMask:true,monitorWindowResize:true,autoHeight:false,selModel:new Ext.grid.RowSelectionModel({singleSelect:false}),enableColLock:false});this.grid.getSelectionModel().on('rowselect',function(sm,rowIndex,record){if(this.lastSelectedRecord!==record){this.lastSelectedRecord=record;this.loadOrder({id:record.data.order_id});}},this)
this.grid.render();var gridHead=this.grid.getView().getHeaderPanel(true);var gridFoot=this.grid.getView().getFooterPanel(true);var paging=new Ext.PagingToolbar(gridHead,this.grid.getDataSource(),{pageSize:this.gridPageSize,displayInfo:true,displayMsg:'Orders {0} - {1} of {2}',emptyMsg:'No orders to display'});paging.items.map.item5.enable();},loadOrder:function(config){if(this.formPanel===null){this.createEditPanel(config.id||0);}else{this.centerLayout.add('south',this.cardPanel);this.formPanel.setUrl(this.formUrl,{id:config.id});this.formPanel.refresh();}
if(this.lastSelectedRecord){this.cardPanel.setTitle(this.lastSelectedRecord.json.form_panel_title||'Order Info Panel');}else{this.cardPanel.setTitle(config.form_panel_title||'Order Info Panel');}},createEditPanel:function(order_id){var baseEl=this.centerLayout.getRegion('south').getEl().createChild({tag:'div'});var layout=new Ext.BorderLayout(baseEl,{north:{autoScroll:false},center:{autoScroll:true}});var layoutBaseEl=layout.getEl().createChild({tag:'div'});var toolbar=this.createFormToolbar({baseEl:layoutBaseEl.createChild({tag:'div'})});layout.add('north',new Ext.ContentPanel(layoutBaseEl,{autoCreate:true,toolbar:toolbar}));this.formPanel=layout.add('center',new Ext.ContentPanel(Ext.id(),{autoCreate:true,url:this.formUrl,params:{id:order_id}}));this.cardPanel=this.centerLayout.add('south',new Ext.NestedLayoutPanel(layout,{closable:true,title:'Order Info'}));},createFormToolbar:function(config){this.toolbar=new Ext.Toolbar(config.baseEl);this.toolbar.add(new Ext.ToolbarButton({text:'Save',cls:'x-btn-text-icon btn-accept',handler:this.onSaveForm.createDelegate(this)}));this.toolbar.add(new Ext.ToolbarButton({text:'Reset',cls:'x-btn-text-icon btn-arrow-undo',handler:function(){var form=Ext.DomQuery.selectNode("form",this.formPanel.getEl().dom);if(form){form.reset();}},scope:this}));this.toolbar.add(new Ext.ToolbarButton({text:'Cancel',cls:'x-btn-text-icon btn-cancel',handler:function(){this.centerLayout.getRegion('south').remove(this.cardPanel);},scope:this}));return this.toolbar;},onSaveForm:function(){var form=Ext.DomQuery.selectNode("form",this.formPanel.getEl().dom);if(form){var um=this.formPanel.getUpdateManager();um.formUpdate(form,form.action);}}}}();

Mage.Menu_Sales=function(){var menu;return{init:function(){menu=new Ext.menu.Menu({id:'mainSalesMenu',items:[new Ext.menu.Item({text:'Orders',handler:Mage.Sales.loadMainPanel.createDelegate(Mage.Sales)})]});Mage.Core.addLeftToolbarItem({cls:'x-btn-text-icon .btn-sales',text:'Sales',menu:menu});}}}();Mage.Menu_Sales.init();
